define(["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/ol3-layerswitcher","core/str"],function(fe,e,t,me,ve,ye,be,o,i){function c(t,o,i,a,r,n){var p="EPSG:3857",e=new ve.proj.Projection(p),s=null,l=!0;if(void 0!==n&&null!=n){if(null!=n.custombackgroundurl){var d=ve.proj.transformExtent(n.bbox,"EPSG:4326",p);if(!n.geographic){d[2],d[0];var c=d[3]-d[1],u=(d[2]+d[0])/2,g=(d[3]+d[1])/2,h=Math.round(c/n.imgheight),f=Math.round(n.imgwidth*h),m=Math.round(n.imgheight*h);d=[u-f/2,g-m/2,u+f/2,g+m/2]}s=new ve.layer.Image({title:n.layername,type:n.layertype,source:new ve.source.ImageStatic({url:n.custombackgroundurl,imageExtent:d}),opacity:1})}else if(null!=n.wmsurl){var v={source:new ve.source.TileWMS({url:n.wmsurl,params:n.wmsparams}),type:n.layertype,title:n.layername};if(null!=n.bbox[0]&&null!=n.bbox[1]&&null!=n.bbox[2]&&null!=n.bbox[3]){var y=ve.proj.transformExtent(n.bbox,"EPSG:4326",p);v.extent=y}s=new ve.layer.Tile(v)}l=n.geographic}var b,w,F,P,I={roads:{}},C=new ve.source.Vector({projection:p}),x=new ve.source.Vector({projection:p}),k=!1,S=!1,E=!1,A={},T=1,z=new ve.layer.Vector({source:new ve.source.Vector({projection:p})}),B=be.createGeocoder("openstreetmap");function j(e,t,o,i,a,r){var n,s=fe(e).get([o]),l=fe(s).attr("roadid");n=Math.abs(fe(s).index('li[roadid="'+l+'"]')-t),fe(s).attr("stageposition",n),fe(s).find(".sortable-number").text(n),fe(s).hasClass("ui-selected")&&(b=n),function(e,t,o,i,a){var r,n=o.getFeatureById(e);n||((n=i.getFeatureById(e).clone()).setId(e),o.addFeature(n));if(n.setProperties({stageposition:t}),"empty"!==n.get("idFeaturesPolygons")){r=n.get("idFeaturesPolygons").split(",");for(var s=0,l=r.length;s<l;s++)a.getSource().getFeatureById(r[s]).setProperties({stageposition:t})}}(parseInt(fe(s).attr("stageid"),10),n,(parseInt(fe(s).attr("roadid"),10),i),a,r)}l&&(fe('<div id="searchcontainer">').appendTo(fe("#controlpanel")),fe('<input type="search" placeholder="'+i.searchlocation+'" class="searchaddress"/>').appendTo(fe("#searchcontainer")),fe('<span class="ui-icon  ui-icon-search searchicon"></span>').prependTo(fe("#searchcontainer")),fe('<span class="ui-icon  ui-icon-closethick closeicon invisible"></span>').appendTo(fe("#searchcontainer"))),fe('<ul id="stagelist"/>').prependTo(fe("#stagelistpanel")),fe("#stagelist").sortable({handle:".handle",tolerance:"pointer",zIndex:9999,opacity:.5,forcePlaceholderSize:!0,cursorAt:{top:-7},cursor:"n-resize",axis:"y",items:"li:not(:hidden , .blocked)",helper:"clone",start:function(e,t){var o=t.item.attr("roadid"),i=t.item.index('li[roadid="'+o+'"]'),a=fe(this).data("ui-sortable").scrollParent,r=a[0].scrollHeight-a[0].clientHeight-t.helper.height();t.item.data("start_pos",i),fe(this).data("maxScrollTop",r)},sort:function(e,t){var o=fe(this).data("ui-sortable").scrollParent,i=fe(this).data("maxScrollTop");o.scrollTop()>i&&o.scrollTop(i)},update:function(e,t){var o,i=t.item.data("start_pos"),a=t.item.attr("roadid"),r=t.item.index('li[roadid="'+a+'"]'),n=fe(this).children('li[roadid="'+a+'"]'),s=fe(n).length;if(i!==r){if(i<r)for(o=i;o<=r;o++)j(n,s,o,C,x,I.roads[a].vector);else for(o=r;o<=i;o++)j(n,s,o,C,x,I.roads[a].vector);ae(),k=!0}}}).disableSelection(),fe('<ul id="roadlist"/>').appendTo(fe("#roadlistpanel")),window.app={};var G=window.app;G.generateResizableControl=function(e){var t=e||{},o=document.createElement("button"),i=document.createElement("div");o.innerHTML="<>",o.id="egrip",i.className="ol-control ol-unselectable egrip-container",i.appendChild(o),ve.control.Control.call(this,{element:i,target:t.target})},ve.inherits(G.generateResizableControl,ve.control.Control);var _=new ve.style.Style({fill:new ve.style.Fill({color:"rgba(100, 100, 255, 0.2)"}),stroke:new ve.style.Stroke({color:"rgba(100, 100, 255, 0.5)",width:2}),image:new ve.style.Circle({radius:5,fill:new ve.style.Fill({color:"#ffcc33"}),stroke:new ve.style.Stroke({color:"#000000",width:2})}),text:new ve.style.Text({textAlign:"center",scale:1.3,fill:new ve.style.Fill({color:"#fff"}),stroke:new ve.style.Stroke({color:"#6C0492",width:3.5})})}),L=new ve.style.Style({fill:new ve.style.Fill({color:"rgba(200, 100, 100, 0.2)"}),stroke:new ve.style.Stroke({color:"rgba(255, 0, 0, 0.5)",width:3}),image:new ve.style.Circle({radius:5,fill:new ve.style.Fill({color:"#ffcc33"}),stroke:new ve.style.Stroke({color:"#000000",width:2})}),text:new ve.style.Text({textAlign:"center",scale:1.3,fill:new ve.style.Fill({color:"#fff"}),stroke:new ve.style.Stroke({color:"#C3000B",width:3.5})}),zIndex:"Infinity"}),M=new ve.layer.Vector({source:new ve.source.Vector({projection:"EPSG:3857"}),visible:!1}),V=new ve.layer.Group({title:i.basemaps,layers:[new ve.layer.Tile({title:i.aerialmap,type:"base",visible:!1,source:new ve.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new ve.layer.Tile({title:i.roadmap,type:"base",visible:!0,source:new ve.source.OSM})]});null!=s&&(n.onlybase&&V.getLayers().clear(),V.getLayers().push(s));var O=document.getElementById("popup"),D=document.getElementById("popup-content"),H=document.getElementById("popup-closer"),N=new ve.Overlay({element:O,autoPan:!0,autoPanAnimation:{duration:250}});H.onclick=function(){return N.setPosition(void 0),H.blur(),!1};var W=new ve.control.LayerSwitcher,q=new ve.Map({layers:[V,M],overlays:[N],projection:e,renderer:"canvas",target:"mapedit",view:new ve.View({center:[0,0],zoom:2,minZoom:2}),controls:ve.control.defaults().extend([W,new G.generateResizableControl({target:document.getElementById("stagelistpanel")})])});q.on("click",function(e){var t,o,i,a;K.getActive()||R.getActive()||null!==n&&!n.geographic||(t=e.coordinate,o=ve.proj.toLonLat(t,q.getView().getProjection()),i=ve.coordinate.toStringHDMS(o),a='<a target="street" href="http://maps.google.com/?cbll='+o[1]+","+o[0]+'&cbp=12,20.09,,0,5&layer=c"><img src="pix/my_location.png" width="16" /></a>',D.innerHTML="<code>"+a+i+"</code>",N.setPosition(t))}),W.showPanel(),fe("#stagelistpanel").resizable({handles:{e:fe("#egrip")},resize:function(e,t){t.size.height=t.originalSize.height},stop:function(e,t){q.updateSize()},cancel:""});var R={init:function(){this.select=new ve.interaction.Select({filter:function(e){return!!A[e.getId()]},style:function(e){var t=new ve.style.Fill({color:"rgba(255,100,100,0.4)"}),o=new ve.style.Stroke({color:"rgba(255, 0, 0, 1)",width:4});return[new ve.style.Style({image:new ve.style.Circle({fill:t,stroke:o,radius:5}),fill:t,stroke:o,text:new ve.style.Text({text:""+e.get("stageposition"),textAlign:"center",scale:1.3,fill:new ve.style.Fill({color:"#fff"}),stroke:new ve.style.Stroke({color:"rgba(255, 0, 0, 1)",width:3.5})}),zIndex:"Infinity"})]}}),q.addInteraction(this.select),this.modify=new ve.interaction.Modify({features:this.select.getFeatures(),style:new ve.style.Style({image:new ve.style.Circle({radius:5,fill:new ve.style.Fill({color:"#3399CC"}),stroke:new ve.style.Stroke({color:"#000000",width:2})})}),deleteCondition:function(e){return ve.events.condition.shiftKeyOnly(e)&&ve.events.condition.singleClick(e)}}),q.addInteraction(this.modify),this.setEvents()},setEvents:function(){P=this.select.getFeatures(),this.select.on("change:active",function(){P.clear(),U()}),this.select.on("select",function(){0<P.getLength()?fe("#removefeature").prop("disabled",!1):U()}),this.modify.on("modifyend",function(e){var t,s,l,d;ae(),t=e.features,s=x,l=C,d=I.roads[w].vector,t.forEach(function(e){var t,o=e.get("stageid"),i=l.getFeatureById(o);i||((i=s.getFeatureById(o).clone()).setId(o),l.addFeature(i));for(var a=new ve.geom.MultiPolygon([]),r=0,n=(t=i.get("idFeaturesPolygons").split(",")).length;r<n;r++)a.appendPolygon(d.getSource().getFeatureById(t[r]).getGeometry().clone());i.setGeometry(a)}),k=!0})},getActive:function(){return!(!this.select.getActive()||!this.modify.getActive())},setActive:function(e){this.select.setActive(e),this.modify.setActive(e)}};R.init();var K={init:function(){q.addInteraction(this.Polygon),this.Polygon.setActive(!1),this.setEvents()},Polygon:new ve.interaction.Draw({source:M.getSource(),type:"Polygon",style:new ve.style.Style({fill:new ve.style.Fill({color:"rgba(0, 0, 0, 0.05)"}),stroke:new ve.style.Stroke({color:"#FAC30B",width:2}),image:new ve.style.Circle({radius:5,fill:new ve.style.Fill({color:"#ffcc33"}),stroke:new ve.style.Stroke({color:"#000000",width:2})}),zIndex:"Infinity"})}),setEvents:function(){this.Polygon.on("drawend",function(e){E=!1,S?(M.getSource().clear(),S=!1):(e.feature.setProperties({roadid:w,stageid:F,stageposition:b}),A[T]=!0,e.feature.setId(T),T++,I.roads[w].vector.getSource().addFeature(e.feature),function(e,t,o){var i=e.get("stageid"),a=e.get("roadid"),r=o.getFeatureById(i);r||((r=t.getFeatureById(i).clone()).setId(i),o.addFeature(r));"empty"===r.get("idFeaturesPolygons")?(r.setProperties({idFeaturesPolygons:""+e.getId()}),function(e,t){if(fe('#stagelist li[stageid="'+e+'"]').children(".handle, .nohandle").addClass("validstage").removeClass("invalidstage"),t){fe("label[for='addradio']").removeClass("highlightbutton"),0===fe("#stagelist li[roadid='"+t+"']").find(".invalidstage").length&&fe("#erremptystage").addClass("invisible")}}(i,a)):r.setProperties({idFeaturesPolygons:r.get("idFeaturesPolygons")+","+e.getId()});r.getGeometry().appendPolygon(e.getGeometry())}(e.feature,x,C),M.getSource().clear(),ae(),k=!0)}),this.Polygon.on("drawstart",function(e){E=!0})},getActive:function(){return this.Polygon.getActive()},setActive:function(e){e?this.Polygon.setActive(!0):this.Polygon.setActive(!1),q.getTargetElement().style.cursor=e?"none":""}};fe(document).keyup(function(e){27===e.keyCode&&E&&(S=!0,K.Polygon.finishDrawing())}),K.init(),oe(),te();var J,X=new ve.interaction.Snap({source:M.getSource()});function Y(e){var t=e.get("stageposition");return isNaN(t)||(L.getText().setText(""+t),_.getText().setText(""+t)),A[e.getId()]?[L]:[_]}function Z(e,t){var o=0;for(var i in e)if(I.roads.hasOwnProperty(i)){o=1,(e[w=i].blocked?ee:$)(),se(w,e[w].vector,t);break}0===o&&(ee(),fe("#addroad").addClass("highlightbutton").blur(),fe("#stagelistpanel").addClass("invisible"),t.updateSize())}function Q(e,t){fe('#stagelist li[stageid="'+e+'"]').children(".handle,.nohandle").addClass("invalidstage").removeClass("validstage"),t&&(fe("label[for='addradio']").addClass("highlightbutton"),2<=fe("#stagelist li[roadid='"+t+"']").length&&fe("#erremptystage").removeClass("invisible"))}function U(){fe("#removefeature").prop("disabled",!0)}function $(){fe("#addstage").prop("disabled",!1)}function ee(){fe("#addstage").prop("disabled",!0)}function te(){fe("#editmode").prop("disabled",!0),fe("#drawmode").prop("disabled",!0),oe()}function oe(){fe("#editmode").removeClass("selectedbutton").prop("z-index","Infinity"),fe("#drawmode").removeClass("selectedbutton").prop("z-index","Infinity"),fe("#navmode").prop("disabled",!1).addClass("selectedbutton").blur().prop("z-index",999),K.setActive(!1),R.setActive(!1)}function ie(){fe("#editmode").addClass("selectedbutton").blur().prop("z-index",999),fe("#drawmode").removeClass("selectedbutton").prop("z-index","Infinity"),fe("#navmode").removeClass("selectedbutton").prop("z-index","Infinity"),K.setActive(!1),R.setActive(!0)}function ae(){fe("#savestage").prop("disabled",!1)}function re(e,t,o){var i=e.getView();o?i.fit(o,{duration:700}):i.animate({zoom:19,center:t,duration:700})}function ne(e){0<e.length?fe("#stagelistpanel").removeClass("invisible"):fe("#stagelistpanel").addClass("invisible"),q.updateSize(),e.length<2?(fe("#addstage").addClass("highlightbutton").blur(),fe("#errvalidroad").removeClass("invisible"),fe("#erremptystage").addClass("invisible")):0<e.find(".invalidstage").length?(fe("#addstage").removeClass("highlightbutton"),fe("#errvalidroad").addClass("invisible"),fe("#erremptystage").removeClass("invisible")):(fe("#addstage").removeClass("highlightbutton"),fe("#errvalidroad").addClass("invisible"),fe("#erremptystage").addClass("invisible"))}function se(e,t,o){fe("#stagelist li").removeClass("ui-selected").hide();var i=fe("#stagelist li[roadid='"+e+"']");i.show(),ne(i),fe("#roadlist li[roadid='"+e+"']").addClass("ui-selected"),o.getLayers().forEach(function(e){e instanceof ve.layer.Vector&&e.setVisible(!1)}),t.setVisible(!0),0<t.getSource().getFeatures().length&&re(o,null,t.getSource().getExtent())}function le(e,t){var o="editstage.php?cmid="+t+"&id="+e;window.location.href=o}function de(e,t){var o="editstage.php?cmid="+t+"&roadid="+e;window.location.href=o}function ce(e,t){var o="editroad.php?cmid="+t+"&id="+e;window.location.href=o}function ue(e){var t="editroad.php?cmid="+e;window.location.href=t}function ge(a,r,n,e,t){fe(".treasurehunt-editor-loader").show(),ye.call([{methodname:"mod_treasurehunt_delete_road",args:{roadid:a,treasurehuntid:e,lockid:t}}])[0].done(function(e){if(fe(".treasurehunt-editor-loader").hide(),e.status.code)me.alert("Error",e.status.msg,"Continue");else{!function(e){var t=fe('#roadlist li[roadid="'+e+'"]');if(0<t.length){var o=fe('#stagelist li[roadid="'+e+'"]');t.remove(),o.remove()}}(a),q.removeLayer(I.roads[a].vector),delete I.roads[a],Z(I.roads,q),te();for(var t=n.getFeatures(),o=0;o<t.length;o++)if(a===t[o].get("roadid")){var i=r.getFeatureById(t[o].getId());i&&r.removeFeature(i),n.removeFeature(t[o])}}}).fail(function(e){fe(".treasurehunt-editor-loader").hide(),console.log(e),me.exception(e)})}function pe(n,s,l,d,e,t){fe(".treasurehunt-editor-loader").show(),ye.call([{methodname:"mod_treasurehunt_delete_stage",args:{stageid:n,treasurehuntid:e,lockid:t}}])[0].done(function(e){if(fe(".treasurehunt-editor-loader").hide(),e.status.code)me.alert("Error",e.status.msg,"Continue");else{var t,o=!1,i=s.getFeatureById(n);if(!function(e,t,o,i){var a=fe('#stagelist li[stageid="'+e+'"]');if(0<a.length){var r=a.attr("roadid"),n=a.index('li[roadid="'+r+'"]');a.remove();var s=fe("#stagelist li[roadid='"+r+"']");ne(s);for(var l=s.length,d=0;d<=n-1;d++)j(s,l,d,t,o,i)}}(n,s,l,d),i?("empty"!==i.get("idFeaturesPolygons")&&(o=i.get("idFeaturesPolygons").split(",")),s.removeFeature(i)):("empty"!==(i=l.getFeatureById(n)).get("idFeaturesPolygons")&&(o=i.get("idFeaturesPolygons").split(",")),l.removeFeature(i)),o)for(var a=0,r=o.length;a<r;a++)t=d.getSource().getFeatureById(o[a]),d.getSource().removeFeature(t)}}).fail(function(e){fe(".treasurehunt-editor-loader").hide(),console.log(e),me.exception(e)})}function he(o,i,e,a,r,t){fe(".treasurehunt-editor-loader").show();var n,s=new ve.format.GeoJSON,l=o.getFeatures(),d=[];l.forEach(function(e){(n=e.clone()).unset("idFeaturesPolygons"),n.unset("name"),n.unset("clue"),n.unset("treasurehuntid"),n.setId(e.getId()),d.push(n)});var c=s.writeFeaturesObject(d,{dataProjection:"EPSG:4326",featureProjection:p});ye.call([{methodname:"mod_treasurehunt_update_stages",args:{stages:c,treasurehuntid:e,lockid:t}}])[0].done(function(e){var t;(fe(".treasurehunt-editor-loader").hide(),e.status.code)?me.alert("Error",e.status.msg,"Continue"):(o.forEachFeature(function(e){(t=i.getFeatureById(e.getId())).setProperties(e.getProperties()),t.setGeometry(e.getGeometry())}),o.clear(),fe("#savestage").prop("disabled",!0),k=!1,"function"==typeof a&&r instanceof Array&&a.apply(null,r))}).fail(function(e){fe(".treasurehunt-editor-loader").hide(),console.log(e),me.alert("Error",e.message,"Continue")})}q.addInteraction(X),J=o,ye.call([{methodname:"mod_treasurehunt_fetch_treasurehunt",args:{treasurehuntid:J}}])[0].done(function(e){if(fe(".treasurehunt-editor-loader").hide(),e.status.code)me.alert("Error",e.status.msg,"Continue");else{e.treasurehunt.stages;var g,t,o=new ve.format.GeoJSON,i=e.treasurehunt.roads;Array.isArray(i)||(i=Object.values(i)),i.forEach(function(u){u.blocked=1==u.blocked,function(e,t,o){if(fe('#roadlist li[roadid="'+e+'"]').length<1){fe('<li roadid="'+e+'" blocked="'+o+'"/>').appendTo(fe("#roadlist")).addClass("ui-corner-all").append("<div class='roadname'>"+t+"</div>").append("<div class='modifyroad'><span class='ui-icon ui-icon-trash'></span><span class='ui-icon ui-icon-pencil'></span></div>")}}(u.id,u.name,u.blocked),t=o.readFeatures(u.stages,{dataProjection:"EPSG:4326",featureProjection:p}),x.addFeatures(t),delete u.stages,g=new ve.layer.Vector({source:new ve.source.Vector({projection:p}),updateWhileAnimating:!0,style:Y}),t.forEach(function(e){null===e.getGeometry()&&e.setGeometry(new ve.geom.MultiPolygon([]));for(var t=e.getGeometry().getPolygons(),o="empty",i=e.get("stageposition"),a=e.get("name"),r=e.get("clue"),n=e.getId(),s=u.blocked,l=0;l<t.length;l++){var d=new ve.Feature(e.getProperties());d.setProperties({stageid:n});var c=t[l];d.setGeometry(c),d.setId(T),o=0===l?T:o+","+T,T++,g.getSource().addFeature(d)}e.setProperties({idFeaturesPolygons:""+o}),function(e,t,o,i,a,r){if(fe('#stagelist li[stageid="'+e+'"]').length<1){var n=fe('<li stageid="'+e+'" roadid="'+t+'" stageposition="'+o+'"/>').appendTo(fe("#stagelist"));n.addClass("ui-corner-all").append("<div class='stagename'>"+i+"</div>").append("<div class='modifystage'><span class='ui-icon ui-icon-pencil'></span><span class='ui-icon ui-icon-info' data-id='#dialoginfo"+e+"'><div id='dialoginfo"+e+"' title='"+i+"'>"+a+"</div></span></div>"),r?n.addClass("blocked").prepend("<div class='nohandle validstage'><span class='ui-icon ui-icon-locked'></span><span class='sortable-number'>"+o+"</span></div>"):(n.prepend("<div class='handle validstage'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><span class='sortable-number'>"+o+"</span></div>"),n.children(".modifystage").prepend("<span class='ui-icon ui-icon-trash'></span>")),fe("#dialoginfo"+e).dialog({maxHeight:500,autoOpen:!1})}else console.log("El li con "+e+" no ha podido crearse porque ya existia uno")}(n,u.id,i,a,r,s),0===t.length&&Q(n)}),u.vector=g,q.addLayer(g),I.roads[u.id]=u}),fe("#stagelist li").sort(function(e,t){var o=parseInt(fe(e).attr("stageposition")),i=parseInt(fe(t).attr("stageposition"));return o<i?1:i<o?-1:0}).appendTo(fe("#stagelist")),void 0!==I.roads[a]?(w=a,(I.roads[w].blocked?ee:$)(),se(w,I.roads[w].vector,q)):Z(I.roads,q)}}).fail(function(e){fe(".treasurehunt-editor-loader").hide(),console.log(e),me.exception(e)}),fe(".searchaddress").autocomplete({minLength:4,source:function(e,s){var t=e.term;B.geocode(t,function(e){if(e[0]){for(var t=[],o=0,i=e.length;o<i;o++){var a,r;a=e[o].getLatitude(),r=e[o].getLongitude();var n={value:e[o].totalName,latitude:a,longitude:r,boundingbox:e[o].boundingbox};t[o]=n}s(t)}else s()})},select:function(e,t){if(t.item.boundingbox){var o=[];o[0]=parseFloat(t.item.boundingbox[2]),o[1]=parseFloat(t.item.boundingbox[0]),o[2]=parseFloat(t.item.boundingbox[3]),o[3]=parseFloat(t.item.boundingbox[1]),o=ve.proj.transformExtent(o,"EPSG:4326",p),re(q,null,o)}else{var i=ve.proj.fromLonLat([t.item.longitude,t.item.latitude]);re(q,i)}},autoFocus:!0}).on("click",function(){fe(this).autocomplete("search",fe(this).value)}),fe.ui.autocomplete.prototype._resizeMenu=function(){this.menu.element.outerWidth(this.element.outerWidth())},fe("#drawmode").css("position","relative").on("click",function(){fe("#drawmode").addClass("selectedbutton").blur().prop("z-index","Infinity"),fe("#editmode").removeClass("selectedbutton").prop("z-index","auto"),fe("#navmode").removeClass("selectedbutton").prop("z-index","auto"),R.setActive(!1),K.setActive(!0)}),fe("#editmode").css("position","relative").on("click",ie),fe("#navmode").css("position","relative").on("click",oe),fe("#addstage").on("click",function(){k?he(C,x,o,de,[w,t],r):de(w,t)}),fe("#addroad").on("click",function(){k?he(C,x,o,ue,[t],r):ue(t)}),fe("#removefeature").on("click",function(){me.confirm(i.areyousure,i.removewarning,i.confirm,i.cancel,function(){var e,d,c,u,t,o;e=P,d=x,c=C,u=I.roads[w].vector,e.forEach(function(e){var t,o,i=e.get("stageid"),a=e.get("roadid"),r=c.getFeatureById(i);r||((r=d.getFeatureById(i).clone()).setId(i),c.addFeature(r));for(var n=new ve.geom.MultiPolygon([]),s=0,l=(t=r.get("idFeaturesPolygons").split(",")).length;s<l;s++)t[s]!=e.getId()?n.appendPolygon(u.getSource().getFeatureById(t[s]).getGeometry().clone()):o=s;r.setGeometry(n),n.getPolygons().length?(t.splice(o,1),r.setProperties({idFeaturesPolygons:t.join()})):(r.setProperties({idFeaturesPolygons:"empty"}),Q(i,a))}),t=P,o=I.roads[w].vector,t.forEach(function(e){o.getSource().removeFeature(e)}),t.clear(),U(),ae(),k=!0})}),fe("#savestage").on("click",function(){he(C,x,o,null,null,r)}),fe("#stagelist").on("click",".ui-icon-info, .ui-icon-alert",function(){var e=fe(this).data("id");fe(e).dialog("open"),fe(".ui-dialog :button").blur()}),fe("#stagelist").on("click",".ui-icon-trash",function(){var e=fe(this).parents("li");me.confirm(i.areyousure,i.removewarning,i.confirm,i.cancel,function(){pe(parseInt(e.attr("stageid")),C,x,I.roads[w].vector,o,r)})}),fe("#stagelist").on("click",".ui-icon-pencil",function(){var e=parseInt(fe(this).parents("li").attr("stageid"));k?he(C,x,o,le,[e,t],r):le(e,t)});fe("#stagelist").on("click","li",function(e){fe(e.target).is(".handle ,.nohandle, .ui-icon , .sortable-number")?e.preventDefault():(fe(this).addClass("ui-selected").siblings().removeClass("ui-selected"),b=parseInt(fe(this).attr("stageposition")),F=parseInt(fe(this).attr("stageid")),function(e,t,o,i,a,r){t.getSource().clear(),i.clear(),A={};var n=a.getFeatureById(o);if(n=n||r.getFeatureById(o))if("empty"!==n.get("idFeaturesPolygons")){for(var s=n.get("idFeaturesPolygons").split(","),l=0,d=s.length;l<d;l++)t.getSource().addFeature(e.getSource().getFeatureById(s[l]).clone()),A[s[l]]=!0;t.getSource().getFeatures().length&&re(q,null,t.getSource().getExtent())}else e.changed();else e.changed()}(I.roads[w].vector,z,F,P,C,x),fe("#drawmode").prop("disabled",!1),fe("#editmode").prop("disabled",!1),ie(),0<fe(this).find(".invalidstage").length?fe("label[for='addradio']").addClass("highlightbutton"):fe("label[for='addradio']").removeClass("highlightbutton"),E&&(S=!0,K.Polygon.finishDrawing()))}),fe("#roadlist").on("click","li",function(e){if(fe(e.target).is(".ui-icon"))e.preventDefault();else{fe(this).addClass("ui-selected").siblings().removeClass("ui-selected"),A={},E&&(S=!0,K.Polygon.finishDrawing()),w=fe(this).attr("roadid");var t,o=fe(this).attr("blocked");(parseInt(o)||"true"===o?ee:$)(),se(w,I.roads[w].vector,q),te(),t="fixed"===fe("header[role=banner]").css("position")?parseInt(fe(".treasurehunt-editor").offset().top)-parseInt(fe("header[role=banner]").outerHeight(!0)):parseInt(fe(".treasurehunt-editor").offset().top),fe("html, body").animate({scrollTop:t},500)}}),fe("#roadlist").on("click",".ui-icon-pencil",function(){var e=parseInt(fe(this).parents("li").attr("roadid"));k?he(C,x,o,ce,[e,t],r):ce(e,t)}),fe("#roadlist").on("click",".ui-icon-trash",function(){var e=fe(this).parents("li");me.confirm(i.areyousure,i.removeroadwarning,i.confirm,i.cancel,function(){ge(parseInt(e.attr("roadid")),C,x,o,r)})}),q.on("pointermove",function(e){if(!e.dragging&&!K.getActive()&&R.getActive()){var t=q.getEventPixel(e.originalEvent),o=q.forEachFeatureAtPixel(t,function(t,e){if(A[t.getId()]){var o=!1;return P.forEach(function(e){t===e&&(o=!0)}),!o}return!1});q.getTargetElement().style.cursor=o?"pointer":""}}),fe(document).on("touchend",".ui-dialog-titlebar-close",function(){fe(this).parent().siblings(".ui-dialog-content").dialog("close")}),fe(".searchaddress").on("input",function(){fe(".closeicon")[this.value?"removeClass":"addClass"]("invisible")}),fe(".closeicon").on("touchstart click",function(e){e.preventDefault(),fe(this).addClass("invisible"),fe(".searchaddress").val("").change().autocomplete("close")}),window.onbeforeunload=function(e){var t=i.savewarning;e=e||window.event;if(k)return e&&(e.returnValue=t),t}}return{edittreasurehunt:function(a,r,n,s,l){var d=["stage","road","aerialmap","roadmap","basemaps","add","modify","save","remove","searchlocation","savewarning","removewarning","areyousure","removeroadwarning","confirm","cancel"],e=d.map(function(e){return{key:e,component:"treasurehunt"}});i.get_strings(e).done(function(e){for(var t=[],o=0;o<d.length;o++)t[d[o]]=e[o];if(null!=l&&null!==l.custombackgroundurl){var i=new Image;i.addEventListener("load",function(){l.imgwidth=this.naturalWidth,l.imgheight=this.naturalHeight,c(a,r,t,n,s,l)}),i.src=l.custombackgroundurl}else c(a,r,t,n,s,l)})}}});
//# sourceMappingURL=edit.min.js.map
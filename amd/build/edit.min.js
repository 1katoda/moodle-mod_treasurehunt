"use strict";define(["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/osm-geocoder","mod_treasurehunt/ol3-layerswitcher","core/str","mod_treasurehunt/viewgpx"],function(ge,e,t,pe,he,fe,me,o,i,ve){function c(t,o,i,a,n,r){var e,s,l,d,c,u,g,p,h,f="EPSG:3857",m=new he.proj.Projection(f),v=null,y=!0;void 0!==r&&null!=r&&(null!=r.custombackgroundurl?(g=he.proj.transformExtent(r.bbox,"EPSG:4326",f),r.geographic||(g[2],g[0],e=g[3]-g[1],s=(g[2]+g[0])/2,l=(g[3]+g[1])/2,d=Math.round(e/r.imgheight),g=[s-(c=Math.round(r.imgwidth*d))/2,l-(u=Math.round(r.imgheight*d))/2,s+c/2,l+u/2]),v=new he.layer.Image({title:r.layername,type:r.layertype,source:new he.source.ImageStatic({url:r.custombackgroundurl,imageExtent:g}),opacity:1})):null!=r.wmsurl&&(p={source:new he.source.TileWMS({url:r.wmsurl,params:r.wmsparams}),type:r.layertype,title:r.layername},null!=r.bbox[0]&&null!=r.bbox[1]&&null!=r.bbox[2]&&null!=r.bbox[3]&&(h=he.proj.transformExtent(r.bbox,"EPSG:4326",f),p.extent=h),v=new he.layer.Tile(p)),y=r.geographic);var b,w,F,C,I,P={roads:{}},x=new he.source.Vector({projection:f}),k=new he.source.Vector({projection:f}),S=!1,E=!1,A=!1,T={},z=1,B=new he.layer.Vector({source:new he.source.Vector({projection:f})});function j(e,t,o,i,a,n){var r=ge(e).get([o]),s=ge(r).attr("roadid"),l=Math.abs(ge(r).index('li[roadid="'+s+'"]')-t);ge(r).attr("stageposition",l),ge(r).find(".sortable-number").text(l),ge(r).hasClass("ui-selected")&&(b=l),function(e,t,o,i,a){var n,r=o.getFeatureById(e);r||((r=i.getFeatureById(e).clone()).setId(e),o.addFeature(r));if(r.setProperties({stageposition:t}),"empty"!==r.get("idFeaturesPolygons")){n=r.get("idFeaturesPolygons").split(",");for(var s=0,l=n.length;s<l;s++)a.getSource().getFeatureById(n[s]).setProperties({stageposition:t})}}(parseInt(ge(r).attr("stageid"),10),l,(parseInt(ge(r).attr("roadid"),10),i),a,n)}y&&(ge('<div id="searchcontainer">').appendTo(ge("#controlpanel")),ge('<input type="search" placeholder="'+i.searchlocation+'" class="searchaddress"/>').appendTo(ge("#searchcontainer")),ge('<span class="ui-icon  ui-icon-search searchicon"></span>').prependTo(ge("#searchcontainer")),ge('<span class="ui-icon  ui-icon-closethick closeicon invisible"></span>').appendTo(ge("#searchcontainer"))),ge('<ul id="stagelist"/>').prependTo(ge("#stagelistpanel")),ge("#stagelist").sortable({handle:".handle",tolerance:"pointer",zIndex:9999,opacity:.5,forcePlaceholderSize:!0,cursorAt:{top:-7},cursor:"n-resize",axis:"y",items:"li:not(:hidden , .blocked)",helper:"clone",start:function(e,t){var o=t.item.attr("roadid"),i=t.item.index('li[roadid="'+o+'"]'),a=ge(this).data("ui-sortable").scrollParent,n=a[0].scrollHeight-a[0].clientHeight-t.helper.height();t.item.data("start_pos",i),ge(this).data("maxScrollTop",n)},sort:function(){var e=ge(this).data("ui-sortable").scrollParent,t=ge(this).data("maxScrollTop");e.scrollTop()>t&&e.scrollTop(t)},update:function(e,t){var o,i=t.item.data("start_pos"),a=t.item.attr("roadid"),n=t.item.index('li[roadid="'+a+'"]'),r=ge(this).children('li[roadid="'+a+'"]'),s=ge(r).length;if(i!==n){if(i<n)for(o=i;o<=n;o++)j(r,s,o,x,k,P.roads[a].vector);else for(o=n;o<=i;o++)j(r,s,o,x,k,P.roads[a].vector);te(),S=!0}}}).disableSelection(),ge('<ul id="roadlist"/>').appendTo(ge("#roadlistpanel")),window.app={};var G=window.app;G.generateResizableControl=function(e){var t=e||{},o=document.createElement("button"),i=document.createElement("div");o.innerHTML="<>",o.id="egrip",i.className="ol-control ol-unselectable egrip-container",i.appendChild(o),he.control.Control.call(this,{element:i,target:t.target})},he.inherits(G.generateResizableControl,he.control.Control);var _=new he.style.Style({fill:new he.style.Fill({color:"rgba(100, 100, 255, 0.2)"}),stroke:new he.style.Stroke({color:"rgba(100, 100, 255, 0.5)",width:2}),image:new he.style.Circle({radius:5,fill:new he.style.Fill({color:"#ffcc33"}),stroke:new he.style.Stroke({color:"#000000",width:2})}),text:new he.style.Text({textAlign:"center",scale:1.3,fill:new he.style.Fill({color:"#fff"}),stroke:new he.style.Stroke({color:"#6C0492",width:3.5})})}),M=new he.style.Style({fill:new he.style.Fill({color:"rgba(200, 100, 100, 0.2)"}),stroke:new he.style.Stroke({color:"rgba(255, 0, 0, 0.5)",width:3}),image:new he.style.Circle({radius:5,fill:new he.style.Fill({color:"#ffcc33"}),stroke:new he.style.Stroke({color:"#000000",width:2})}),text:new he.style.Text({textAlign:"center",scale:1.3,fill:new he.style.Fill({color:"#fff"}),stroke:new he.style.Stroke({color:"#C3000B",width:3.5})}),zIndex:"Infinity"}),L=new he.layer.Vector({source:new he.source.Vector({projection:"EPSG:3857"}),visible:!1}),V=new he.layer.Group({title:i.basemaps,layers:[new he.layer.Tile({title:i.aerialmap,type:"base",visible:!1,source:new he.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new he.layer.Tile({title:i.roadmap,type:"base",visible:!0,source:new he.source.OSM})]});null!=v&&(r.onlybase&&V.getLayers().clear(),V.getLayers().push(v));document.getElementById("popup"),document.getElementById("popup-content"),document.getElementById("popup-closer");var O=ve.createCoordsOverlay("#mapedit",null,i.pegmanlabel),D=new he.control.LayerSwitcher,N=new he.Map({layers:[V,L],overlays:[O],projection:m,renderer:"canvas",target:"mapedit",view:new he.View({center:[0,0],zoom:2,minZoom:2}),controls:he.control.defaults().extend([D,new G.generateResizableControl({target:document.getElementById("stagelistpanel")})])});N.on("click",function(e){W.getActive()||H.getActive()||null!==r&&!r.geographic||O.setPosition(e.coordinate)}),D.showPanel(),ge("#stagelistpanel").resizable({handles:{e:ge("#egrip")},resize:function(e,t){t.size.height=t.originalSize.height},stop:function(){N.updateSize()},cancel:""});var H={init:function(){this.select=new he.interaction.Select({filter:function(e){return!!T[e.getId()]},style:function(e){var t=new he.style.Fill({color:"rgba(255,100,100,0.4)"}),o=new he.style.Stroke({color:"rgba(255, 0, 0, 1)",width:4});return[new he.style.Style({image:new he.style.Circle({fill:t,stroke:o,radius:5}),fill:t,stroke:o,text:new he.style.Text({text:""+e.get("stageposition"),textAlign:"center",scale:1.3,fill:new he.style.Fill({color:"#fff"}),stroke:new he.style.Stroke({color:"rgba(255, 0, 0, 1)",width:3.5})}),zIndex:"Infinity"})]}}),N.addInteraction(this.select),this.modify=new he.interaction.Modify({features:this.select.getFeatures(),style:new he.style.Style({image:new he.style.Circle({radius:5,fill:new he.style.Fill({color:"#3399CC"}),stroke:new he.style.Stroke({color:"#000000",width:2})})}),deleteCondition:function(e){return he.events.condition.shiftKeyOnly(e)&&he.events.condition.singleClick(e)}}),N.addInteraction(this.modify),this.setEvents()},setEvents:function(){C=this.select.getFeatures(),this.select.on("change:active",function(){C.clear(),Y()}),this.select.on("select",function(){0<C.getLength()?ge("#removefeature").prop("disabled",!1):Y()}),this.modify.on("modifyend",function(e){var t,s,l,d;te(),t=e.features,s=k,l=x,d=P.roads[w].vector,t.forEach(function(e){var t=e.get("stageid"),o=l.getFeatureById(t);o||((o=s.getFeatureById(t).clone()).setId(t),l.addFeature(o));for(var i,a=new he.geom.MultiPolygon([]),n=0,r=(i=o.get("idFeaturesPolygons").split(",")).length;n<r;n++)a.appendPolygon(d.getSource().getFeatureById(i[n]).getGeometry().clone());o.setGeometry(a)}),S=!0})},getActive:function(){return!(!this.select.getActive()||!this.modify.getActive())},setActive:function(e){this.select.setActive(e),this.modify.setActive(e)}};H.init();var W={init:function(){N.addInteraction(this.Polygon),this.Polygon.setActive(!1),this.setEvents()},Polygon:new he.interaction.Draw({source:L.getSource(),type:"Polygon",style:new he.style.Style({fill:new he.style.Fill({color:"rgba(0, 0, 0, 0.05)"}),stroke:new he.style.Stroke({color:"#FAC30B",width:2}),image:new he.style.Circle({radius:5,fill:new he.style.Fill({color:"#ffcc33"}),stroke:new he.style.Stroke({color:"#000000",width:2})}),zIndex:"Infinity"})}),setEvents:function(){this.Polygon.on("drawend",function(e){A=!1,E?(L.getSource().clear(),E=!1):(e.feature.setProperties({roadid:w,stageid:F,stageposition:b}),T[z]=!0,e.feature.setId(z),z++,P.roads[w].vector.getSource().addFeature(e.feature),function(e,t,o){var i=e.get("stageid"),a=e.get("roadid"),n=o.getFeatureById(i);n||((n=t.getFeatureById(i).clone()).setId(i),o.addFeature(n));"empty"===n.get("idFeaturesPolygons")?(n.setProperties({idFeaturesPolygons:""+e.getId()}),function(e,t){{ge('#stagelist li[stageid="'+e+'"]').children(".handle, .nohandle").addClass("validstage").removeClass("invalidstage"),t&&(ge("label[for='addradio']").removeClass("highlightbutton"),0===ge("#stagelist li[roadid='"+t+"']").find(".invalidstage").length&&ge("#erremptystage").addClass("invisible"))}}(i,a)):n.setProperties({idFeaturesPolygons:n.get("idFeaturesPolygons")+","+e.getId()});n.getGeometry().appendPolygon(e.getGeometry())}(e.feature,k,x),L.getSource().clear(),te(),S=!0)}),this.Polygon.on("drawstart",function(e){A=!0})},getActive:function(){return this.Polygon.getActive()},setActive:function(e){e?this.Polygon.setActive(!0):this.Polygon.setActive(!1),N.getTargetElement().style.cursor=e?"none":""}};ge(document).keyup(function(e){27===e.keyCode&&A&&(E=!0,W.Polygon.finishDrawing())}),W.init(),$(),U();var q,R=new he.interaction.Snap({source:L.getSource()});function K(e){var t=e.get("stageposition");return isNaN(t)||(M.getText().setText(""+t),_.getText().setText(""+t)),T[e.getId()]?[M]:[_]}function J(e,t){var o=0;for(var i in e)if(P.roads.hasOwnProperty(i)){o=1,(e[w=i].blocked?Q:Z)(),ae(w,e[w].vector,t);break}0===o&&(Q(),ge("#addroad").addClass("highlightbutton").blur(),ge("#stagelistpanel").addClass("invisible"),t.updateSize())}function X(e,t){ge('#stagelist li[stageid="'+e+'"]').children(".handle,.nohandle").addClass("invalidstage").removeClass("validstage"),t&&(ge("label[for='addradio']").addClass("highlightbutton"),2<=ge("#stagelist li[roadid='"+t+"']").length&&ge("#erremptystage").removeClass("invisible"))}function Y(){ge("#removefeature").prop("disabled",!0)}function Z(){ge("#addstage").prop("disabled",!1)}function Q(){ge("#addstage").prop("disabled",!0)}function U(){ge("#editmode").prop("disabled",!0),ge("#drawmode").prop("disabled",!0),$()}function $(){ge("#editmode").removeClass("selectedbutton").prop("z-index","Infinity"),ge("#drawmode").removeClass("selectedbutton").prop("z-index","Infinity"),ge("#navmode").prop("disabled",!1).addClass("selectedbutton").blur().prop("z-index",999),W.setActive(!1),H.setActive(!1)}function ee(){ge("#editmode").addClass("selectedbutton").blur().prop("z-index",999),ge("#drawmode").removeClass("selectedbutton").prop("z-index","Infinity"),ge("#navmode").removeClass("selectedbutton").prop("z-index","Infinity"),W.setActive(!1),H.setActive(!0)}function te(){ge("#savestage").prop("disabled",!1)}function oe(e,t,o){var i=e.getView();o?i.fit(o,{duration:700}):i.animate({zoom:19,center:t,duration:700})}function ie(e){0<e.length?ge("#stagelistpanel").removeClass("invisible"):ge("#stagelistpanel").addClass("invisible"),N.updateSize(),e.length<2?(ge("#addstage").addClass("highlightbutton").blur(),ge("#errvalidroad").removeClass("invisible"),ge("#erremptystage").addClass("invisible")):0<e.find(".invalidstage").length?(ge("#addstage").removeClass("highlightbutton"),ge("#errvalidroad").addClass("invisible"),ge("#erremptystage").removeClass("invisible")):(ge("#addstage").removeClass("highlightbutton"),ge("#errvalidroad").addClass("invisible"),ge("#erremptystage").addClass("invisible"))}function ae(e,t,o){ge("#stagelist li").removeClass("ui-selected").hide();var i=ge("#stagelist li[roadid='"+e+"']");i.show(),ie(i),ge("#roadlist li[roadid='"+e+"']").addClass("ui-selected"),o.getLayers().forEach(function(e){e instanceof he.layer.Vector&&e.setVisible(!1)}),t.setVisible(!0),0<t.getSource().getFeatures().length&&oe(o,null,t.getSource().getExtent())}function ne(e,t){var o="editstage.php?cmid="+t+"&id="+e;window.location.href=o}function re(e,t){var o="editstage.php?cmid="+t+"&roadid="+e;window.location.href=o}function se(e,t){var o="editroad.php?cmid="+t+"&id="+e;window.location.href=o}function le(e){var t="editroad.php?cmid="+e;window.location.href=t}function de(s,l,d,e,t){ge(".treasurehunt-editor-loader").show(),fe.call([{methodname:"mod_treasurehunt_delete_road",args:{roadid:s,treasurehuntid:e,lockid:t}}])[0].done(function(e){if(ge(".treasurehunt-editor-loader").hide(),e.status.code)pe.alert("Error",e.status.msg,"Continue");else{0<(r=ge('#roadlist li[roadid="'+(a=s)+'"]')).length&&(n=ge('#stagelist li[roadid="'+a+'"]'),r.remove(),n.remove()),N.removeLayer(P.roads[s].vector),delete P.roads[s],J(P.roads,N),U();for(var t,o=d.getFeatures(),i=0;i<o.length;i++){s===o[i].get("roadid")&&((t=l.getFeatureById(o[i].getId()))&&l.removeFeature(t),d.removeFeature(o[i]))}}var a,n,r}).fail(function(e){ge(".treasurehunt-editor-loader").hide(),console.log(e),pe.exception(e)})}function ce(r,s,l,d,e,t){ge(".treasurehunt-editor-loader").show(),fe.call([{methodname:"mod_treasurehunt_delete_stage",args:{stageid:r,treasurehuntid:e,lockid:t}}])[0].done(function(e){if(ge(".treasurehunt-editor-loader").hide(),e.status.code)pe.alert("Error",e.status.msg,"Continue");else{var t,o=!1,i=s.getFeatureById(r);if(!function(e,t,o,i){var a=ge('#stagelist li[stageid="'+e+'"]');if(0<a.length){var n=a.attr("roadid"),r=a.index('li[roadid="'+n+'"]');a.remove();var s=ge("#stagelist li[roadid='"+n+"']");ie(s);for(var l=s.length,d=0;d<=r-1;d++)j(s,l,d,t,o,i)}}(r,s,l,d),i?("empty"!==i.get("idFeaturesPolygons")&&(o=i.get("idFeaturesPolygons").split(",")),s.removeFeature(i)):("empty"!==(i=l.getFeatureById(r)).get("idFeaturesPolygons")&&(o=i.get("idFeaturesPolygons").split(",")),l.removeFeature(i)),o)for(var a=0,n=o.length;a<n;a++)t=d.getSource().getFeatureById(o[a]),d.getSource().removeFeature(t)}}).fail(function(e){ge(".treasurehunt-editor-loader").hide(),console.log(e),pe.exception(e)})}function ue(o,i,e,a,n,t){ge(".treasurehunt-editor-loader").show();var r,s=new he.format.GeoJSON,l=o.getFeatures(),d=[];l.forEach(function(e){(r=e.clone()).unset("idFeaturesPolygons"),r.unset("name"),r.unset("clue"),r.unset("treasurehuntid"),r.setId(e.getId()),d.push(r)});var c=s.writeFeaturesObject(d,{dataProjection:"EPSG:4326",featureProjection:f});fe.call([{methodname:"mod_treasurehunt_update_stages",args:{stages:c,treasurehuntid:e,lockid:t}}])[0].done(function(e){var t;ge(".treasurehunt-editor-loader").hide(),e.status.code?pe.alert("Error",e.status.msg,"Continue"):(o.forEachFeature(function(e){(t=i.getFeatureById(e.getId())).setProperties(e.getProperties()),t.setGeometry(e.getGeometry())}),o.clear(),ge("#savestage").prop("disabled",!0),S=!1,"function"==typeof a&&n instanceof Array&&a.apply(null,n))}).fail(function(e){ge(".treasurehunt-editor-loader").hide(),console.log(e),pe.alert("Error",e.message,"Continue")})}N.addInteraction(R),q=o,fe.call([{methodname:"mod_treasurehunt_fetch_treasurehunt",args:{treasurehuntid:q}}])[0].done(function(e){var g,t,o,i;ge(".treasurehunt-editor-loader").hide(),e.status.code?pe.alert("Error",e.status.msg,"Continue"):(e.treasurehunt.stages,t=new he.format.GeoJSON,i=e.treasurehunt.roads,Array.isArray(i)||(i=Object.values(i)),i.forEach(function(u){u.blocked=1==u.blocked,function(e,t,o){{ge('#roadlist li[roadid="'+e+'"]').length<1&&ge('<li roadid="'+e+'" blocked="'+o+'"/>').appendTo(ge("#roadlist")).addClass("ui-corner-all").append("<div class='roadname'>"+t+"</div>").append("<div class='modifyroad'><span class='ui-icon ui-icon-trash'></span><span class='ui-icon ui-icon-pencil'></span></div>")}}(u.id,u.name,u.blocked),o=t.readFeatures(u.stages,{dataProjection:"EPSG:4326",featureProjection:f}),k.addFeatures(o),delete u.stages,g=new he.layer.Vector({source:new he.source.Vector({projection:f}),updateWhileAnimating:!0,style:K}),o.forEach(function(e){null===e.getGeometry()&&e.setGeometry(new he.geom.MultiPolygon([]));for(var t=e.getGeometry().getPolygons(),o="empty",i=e.get("stageposition"),a=e.get("name"),n=e.get("clue"),r=e.getId(),s=u.blocked,l=0;l<t.length;l++){var d=new he.Feature(e.getProperties());d.setProperties({stageid:r});var c=t[l];d.setGeometry(c),d.setId(z),o=0===l?z:o+","+z,z++,g.getSource().addFeature(d)}e.setProperties({idFeaturesPolygons:""+o}),function(e,t,o,i,a,n){{var r;ge('#stagelist li[stageid="'+e+'"]').length<1?((r=ge('<li stageid="'+e+'" roadid="'+t+'" stageposition="'+o+'"/>').appendTo(ge("#stagelist"))).addClass("ui-corner-all").append("<div class='stagename'>"+i+"</div>").append("<div class='modifystage'><span class='ui-icon ui-icon-pencil'></span><span class='ui-icon ui-icon-info' data-id='#dialoginfo"+e+"'><div id='dialoginfo"+e+"' title='"+i+"'>"+a+"</div></span></div>"),n?r.addClass("blocked").prepend("<div class='nohandle validstage'><span class='ui-icon ui-icon-locked'></span><span class='sortable-number'>"+o+"</span></div>"):(r.prepend("<div class='handle validstage'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><span class='sortable-number'>"+o+"</span></div>"),r.children(".modifystage").prepend("<span class='ui-icon ui-icon-trash'></span>")),ge("#dialoginfo"+e).dialog({maxHeight:500,autoOpen:!1})):console.log("El li con "+e+" no ha podido crearse porque ya existia uno")}}(r,u.id,i,a,n,s),0===t.length&&X(r)}),u.vector=g,N.addLayer(g),P.roads[u.id]=u}),ge("#stagelist li").sort(function(e,t){var o=parseInt(ge(e).attr("stageposition")),i=parseInt(ge(t).attr("stageposition"));return o<i?1:i<o?-1:0}).appendTo(ge("#stagelist")),void 0!==P.roads[a]?(w=a,(P.roads[w].blocked?Q:Z)(),ae(w,P.roads[w].vector,N)):J(P.roads,N))}).fail(function(e){ge(".treasurehunt-editor-loader").hide(),console.log(e),pe.exception(e)}),ge(".searchaddress").autocomplete({minLength:4,source:function(e,s){var t=e.term;I&&I.abort(),I=me.search(t).done(function(e){if(0!==e.length){for(var t=[],o=0,i=e.length;o<i;o++){var a=e[o].lat,n=e[o].lon,r={value:e[o].display_name,latitude:a,longitude:n,boundingbox:e[o].boundingbox};t[o]=r}s(t)}else s()}).fail(function(){s()}).always(function(){I=null})},select:function(e,t){var o,i;t.item.boundingbox?((o=[])[0]=parseFloat(t.item.boundingbox[2]),o[1]=parseFloat(t.item.boundingbox[0]),o[2]=parseFloat(t.item.boundingbox[3]),o[3]=parseFloat(t.item.boundingbox[1]),o=he.proj.transformExtent(o,"EPSG:4326",f),oe(N,null,o)):(i=he.proj.fromLonLat([t.item.longitude,t.item.latitude]),oe(N,i))},autoFocus:!0}).on("click",function(){ge(this).autocomplete("search",ge(this).value)}),ge.ui.autocomplete.prototype._resizeMenu=function(){this.menu.element.outerWidth(this.element.outerWidth())},ge("#drawmode").css("position","relative").on("click",function(){ge("#drawmode").addClass("selectedbutton").blur().prop("z-index","Infinity"),ge("#editmode").removeClass("selectedbutton").prop("z-index","auto"),ge("#navmode").removeClass("selectedbutton").prop("z-index","auto"),H.setActive(!1),W.setActive(!0)}),ge("#editmode").css("position","relative").on("click",ee),ge("#navmode").css("position","relative").on("click",$),ge("#addstage").on("click",function(){S?ue(x,k,o,re,[w,t],n):re(w,t)}),ge("#addroad").on("click",function(){S?ue(x,k,o,le,[t],n):le(t)}),ge("#removefeature").on("click",function(){pe.confirm(i.areyousure,i.removewarning,i.confirm,i.cancel,function(){var e,d,c,u,t,o;e=C,d=k,c=x,u=P.roads[w].vector,e.forEach(function(e){var t,o=e.get("stageid"),i=e.get("roadid"),a=c.getFeatureById(o);a||((a=d.getFeatureById(o).clone()).setId(o),c.addFeature(a));for(var n,r=new he.geom.MultiPolygon([]),s=0,l=(n=a.get("idFeaturesPolygons").split(",")).length;s<l;s++)n[s]!=e.getId()?r.appendPolygon(u.getSource().getFeatureById(n[s]).getGeometry().clone()):t=s;a.setGeometry(r),r.getPolygons().length?(n.splice(t,1),a.setProperties({idFeaturesPolygons:n.join()})):(a.setProperties({idFeaturesPolygons:"empty"}),X(o,i))}),t=C,o=P.roads[w].vector,t.forEach(function(e){o.getSource().removeFeature(e)}),t.clear(),Y(),te(),S=!0})}),ge("#savestage").on("click",function(){ue(x,k,o,null,null,n)}),ge("#stagelist").on("click",".ui-icon-info, .ui-icon-alert",function(){var e=ge(this).data("id");ge(e).dialog("open"),ge(".ui-dialog :button").blur()}),ge("#stagelist").on("click",".ui-icon-trash",function(){var e=ge(this).parents("li");pe.confirm(i.areyousure,i.removewarning,i.confirm,i.cancel,function(){ce(parseInt(e.attr("stageid")),x,k,P.roads[w].vector,o,n)})}),ge("#stagelist").on("click",".ui-icon-pencil",function(){var e=parseInt(ge(this).parents("li").attr("stageid"));S?ue(x,k,o,ne,[e,t],n):ne(e,t)});ge("#stagelist").on("click","li",function(e){ge(e.target).is(".handle ,.nohandle, .ui-icon , .sortable-number")?e.preventDefault():(ge(this).addClass("ui-selected").siblings().removeClass("ui-selected"),b=parseInt(ge(this).attr("stageposition")),F=parseInt(ge(this).attr("stageid")),function(e,t,o,i,a,n){t.getSource().clear(),i.clear(),T={};var r=a.getFeatureById(o);if(r=r||n.getFeatureById(o))if("empty"!==r.get("idFeaturesPolygons")){for(var s=r.get("idFeaturesPolygons").split(","),l=0,d=s.length;l<d;l++)t.getSource().addFeature(e.getSource().getFeatureById(s[l]).clone()),T[s[l]]=!0;t.getSource().getFeatures().length&&oe(N,null,t.getSource().getExtent())}else e.changed();else e.changed()}(P.roads[w].vector,B,F,C,x,k),ge("#drawmode").prop("disabled",!1),ge("#editmode").prop("disabled",!1),ee(),0<ge(this).find(".invalidstage").length?ge("label[for='addradio']").addClass("highlightbutton"):ge("label[for='addradio']").removeClass("highlightbutton"),A&&(E=!0,W.Polygon.finishDrawing()))}),ge("#roadlist").on("click","li",function(e){var t,o;ge(e.target).is(".ui-icon")?e.preventDefault():(ge(this).addClass("ui-selected").siblings().removeClass("ui-selected"),T={},A&&(E=!0,W.Polygon.finishDrawing()),w=ge(this).attr("roadid"),t=ge(this).attr("blocked"),(parseInt(t)||"true"===t?Q:Z)(),ae(w,P.roads[w].vector,N),U(),o="fixed"===ge("header[role=banner]").css("position")?parseInt(ge(".treasurehunt-editor").offset().top)-parseInt(ge("header[role=banner]").outerHeight(!0)):parseInt(ge(".treasurehunt-editor").offset().top),ge("html, body").animate({scrollTop:o},500))}),ge("#roadlist").on("click",".ui-icon-pencil",function(){var e=parseInt(ge(this).parents("li").attr("roadid"));S?ue(x,k,o,se,[e,t],n):se(e,t)}),ge("#roadlist").on("click",".ui-icon-trash",function(){var e=ge(this).parents("li");pe.confirm(i.areyousure,i.removeroadwarning,i.confirm,i.cancel,function(){de(parseInt(e.attr("roadid")),x,k,o,n)})}),N.on("pointermove",function(e){var t,o;e.dragging||W.getActive()||!H.getActive()||(t=N.getEventPixel(e.originalEvent),o=N.forEachFeatureAtPixel(t,function(t,e){if(T[t.getId()]){var o=!1;return C.forEach(function(e){t===e&&(o=!0)}),!o}return!1}),N.getTargetElement().style.cursor=o?"pointer":"")}),ge(document).on("touchend",".ui-dialog-titlebar-close",function(){ge(this).parent().siblings(".ui-dialog-content").dialog("close")}),ge(".searchaddress").on("input",function(){ge(".closeicon")[this.value?"removeClass":"addClass"]("invisible")}),ge(".closeicon").on("touchstart click",function(e){e.preventDefault(),ge(this).addClass("invisible"),ge(".searchaddress").val("").change().autocomplete("close")}),window.onbeforeunload=function(e){var t=i.savewarning,e=e||window.event;if(S)return e&&(e.returnValue=t),t}}return{edittreasurehunt:function(a,n,r,s,l){var d=["stage","road","aerialmap","roadmap","basemaps","add","modify","save","remove","searchlocation","savewarning","removewarning","areyousure","removeroadwarning","confirm","cancel","pegmanlabel"],e=d.map(function(e){return{key:e,component:"treasurehunt"}});i.get_strings(e).done(function(e){for(var t,o=[],i=0;i<d.length;i++)o[d[i]]=e[i];null!=l&&null!==l.custombackgroundurl?((t=new Image).addEventListener("load",function(){l.imgwidth=this.naturalWidth,l.imgheight=this.naturalHeight,c(a,n,o,r,s,l)}),t.src=l.custombackgroundurl):c(a,n,o,r,s,l)})}}});
//# sourceMappingURL=edit.min.js.map

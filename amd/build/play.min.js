define(["jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/viewgpx","mod_treasurehunt/jquery.truncate","mod_treasurehunt/jquery.mobile-config","mod_treasurehunt/jquerymobile"],function(Ve,Ae,ze,Re,De,Le){return console.log("loading play.js with jquery "+Ve().jquery),{playtreasurehunt:function(e,t,o,n,i,a,l,s,r,c){console.log("loading i18n strings");["stageovercome","failedlocation","stage","stagename","stageclue","question","noanswerselected","timeexceeded","searching","continue","noattempts","aerialview","roadview","noresults","startfromhere","nomarks","updates","activitytoendwarning","huntcompleted","discoveredlocation","answerwarning","error"].map(function(e){return{key:e,component:"treasurehunt"}});if(i18n=i18nplay,null!=c&&null!==c.custombackgroundurl){console.log("Detecting custom background image dimensions.");var u=new Image;u.addEventListener("load",function(){c.imgwidth=this.naturalWidth,c.imgheight=this.naturalHeight,console.log("image is "+this.naturalWidth+"x"+this.naturalHeight+"pixels"),p(i18n,e,t,o,n,i,a,l,s,r,c)}),u.src=c.custombackgroundurl}else p(i18n,e,t,o,n,i,a,l,s,r,c)}};function p(r,c,u,p,d,g,m,e,f,t,o){console.log("init player Openlayers"),Ve.mobile.loading("show");var n="EPSG:3857",i=null,a=!0,l=15;if(null!=o){if(null!=o.custombackgroundurl){console.log("config custom background image");var s=ze.proj.transformExtent(o.bbox,"EPSG:4326",n);if(!o.geographic){s[2],s[0];var h=s[3]-s[1],w=(s[2]+s[0])/2,y=(s[3]+s[1])/2,v=Math.round(h/o.imgheight),b=Math.round(o.imgwidth*v),x=Math.round(o.imgheight*v);s=[w-b/2,y-x/2,w+b/2,y+x/2],l=5}i=new ze.layer.Image({title:o.layername,name:o.layername,type:o.layertype,source:new ze.source.ImageStatic({url:o.custombackgroundurl,imageExtent:s}),opacity:1})}else if(null!==o.wmsurl){console.log("config custom wms server: "+o.wmsurl);var k={source:new ze.source.TileWMS({url:o.wmsurl,params:o.wmsparams}),type:o.layertype,title:o.layername,name:o.layername};if(null!==o.bbox[0]&&null!==o.bbox[1]&&null!==o.bbox[2]&&null!==o.bbox[3]){var S=ze.proj.transformExtent(o.bbox,"EPSG:4326",n);k.extent=S}i=new ze.layer.Tile(k)}a=o.geographic}!1===a&&(console.log("geographic tools disabled"),p=!0,Ve("#autolocate").hide());var T,P=Ae.imageUrl("success_mark","treasurehunt"),q=Ae.imageUrl("failure_mark","treasurehunt"),E=Ae.imageUrl("my_location","treasurehunt"),G=De.createGeocoder("openstreetmap"),I={},_=0,j=0,C=[],F=[],V=!1,A=!1,z=!1,R=!1,D=!1,L=!0,Q=!1,M=new ze.style.Text({textAlign:"center",scale:1.3,fill:new ze.style.Fill({color:"#fff"}),stroke:new ze.style.Stroke({color:"#000",width:3.5})}),O=new ze.style.Text({textAlign:"center",scale:1.4,fill:new ze.style.Fill({color:"#fff"}),stroke:new ze.style.Stroke({color:"#3399CC",width:3.5})}),N=new ze.style.Style({image:new ze.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:P}),text:M,zIndex:"Infinity"}),W=new ze.style.Style({image:new ze.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:q}),text:M,zIndex:"Infinity"}),H=new ze.style.Style({image:new ze.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:P}),text:O,zIndex:"Infinity"}),B=new ze.style.Style({image:new ze.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:q}),text:O,zIndex:"Infinity"}),U=new ze.style.Style({image:new ze.style.Circle({radius:6,fill:new ze.style.Fill({color:[0,0,0,1]}),stroke:new ze.style.Stroke({color:[255,255,255,1],width:2})})}),Z=new ze.style.Style({fill:new ze.style.Fill({color:[255,255,255,.3]}),stroke:new ze.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),K=new ze.style.Style({image:new ze.style.Icon({anchor:[.5,1],opacity:1,scale:.35,src:E})}),X=[],Y=new ze.format.GeoJSON,J=new ze.source.Vector({projection:"EPSG:3857"}),$=new ze.layer.Vector({source:J,style:function(e,t){var o=e.get("stageposition");if(0!==o)return e.get("geometrysolved")?(N.getText().setText(""+o),[N]):(W.getText().setText(""+o),[W]);var n=new ze.style.Fill({color:"rgba(255,255,255,0.4)"}),i=new ze.style.Stroke({color:"#3399CC",width:1.25});return[new ze.style.Style({image:new ze.style.Circle({fill:n,stroke:i,radius:5}),fill:n,stroke:i,text:new ze.style.Text({text:r.startfromhere,textAlign:"center",fill:new ze.style.Fill({color:"rgb(255,255,255)"}),stroke:new ze.style.Stroke({color:"#3399CC",width:5})})})]}}),ee=new ze.layer.Tile({visible:!1,source:new ze.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});ee.set("name",r.aerialview);var te=new ze.layer.Tile({source:new ze.source.OSM});te.set("name",r.roadview);var oe=[],ne=[];null!==o&&!1!==o.onlybase||(oe=[ee,te]),null!==i&&("overlay"!=o.layertype?oe.push(i):ne.push(i));var ie=new ze.layer.Group({layers:oe}),ae=null;ie.getLayers().forEach(function(e){e.setVisible(!1),ae=e}),ae.setVisible(!0);var le=new ze.View({center:[0,0],zoom:2,minZoom:2}),se=new ze.interaction.Select({layers:[$],style:function(e,t){var o=e.get("stageposition");return e.get("geometrysolved")?(H.getText().setText(""+o),[H]):(B.getText().setText(""+o),[B])},filter:function(e,t){return 0!==e.get("stageposition")}}),re=new ze.Feature;re.setProperties({name:"user_accuracy"}),re.setStyle(Z);var ce=new ze.Feature;ce.setProperties({name:"user_position"}),ce.setStyle(U);var ue=new ze.layer.Vector({source:new ze.source.Vector({features:[re,ce]})}),pe=new ze.Feature;pe.setGeometry(null),pe.setStyle(K);var de=new ze.layer.Vector({source:new ze.source.Vector({features:[pe]})});X.push(ie),X=(X=X.concat(ne)).concat([$,ue,de]);var ge,me=new ze.control.Zoom({target:"navigation",className:"custom-zoom"}),fe=new ze.Map({layers:X,controls:[me],target:"mapplay",view:le,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});if(fe.addInteraction(se),xe(!1,!0),T=setInterval(function(){xe(!1,!1)},e),(ge=ie).getLayers().forEach(function(t){var e=Ve("<li>",{"data-icon":"check",class:t.getVisible()?"checked":"unchecked"}).append(Ve("<a />",{text:t.get("name"),href:"#mappage"}).click(function(){ge.getLayers().forEach(function(e){e===t?e.setVisible(!0):e.setVisible(!1)})}));t.on("change:visible",function(){Ve(e).toggleClass("checked unchecked")}),e.insertAfter("#baseLayer")}),ne.forEach(function(e){Pe(e)}),f&&t){var he=Le.addgpxlayer(fe,c,u,r,t,"trackgroup");he.set("name",he.get("title"));var we=he.getLayers().item(0),ye=we.get("title"),ve=ye.substring(ye.indexOf("</a>")+4);we.set("name",ve),we.setVisible(!1),Pe(we)}function be(e,t,o){var n=e.getView();o?n.fit(o,{duration:700}):n.animate({zoom:l,center:t,duration:700})}function xe(n,i,a,e){var t,o,l,s;(l=p?pe.getGeometry():ce.getGeometry())&&(o=Y.writeGeometryObject(l,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),a&&(Ve.mobile.loading("show"),s=a),n&&(t=o,Ve.mobile.loading("show")),Re.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:{treasurehuntid:u,attempttimestamp:g,roadtimestamp:m,playwithoutmoving:p,groupmode:d,initialize:i,location:t,currentposition:f&&!p?o:void 0,selectedanswerid:s,qoaremoved:Q,qrtext:e}}}])[0].done(function(e){var t="";if(Q=e.qoaremoved,D=e.roadfinished,L=e.available,Ve.mobile.loading("hide"),(n||a)&&null!==e.status&&L&&console.log(e.status.msg),e.qrexpected?Ve("#validateqr").show():Ve("#validateqr").hide(),p!=e.playwithoutmoving&&((p=e.playwithoutmoving)||pe.setGeometry(null)),d!=e.groupmode&&(d=e.groupmode),g!==e.attempttimestamp||m!==e.roadtimestamp||i||!L){g=e.attempttimestamp,m=e.roadtimestamp,0<e.historicalattempts.length&&(F=e.historicalattempts,V=!0),(e.attempts||e.firststagegeom)&&(J.clear(),e.firststagegeom&&J.addFeatures(Y.readFeatures(e.firststagegeom,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),0<e.attempts.features.length&&J.addFeatures(Y.readFeatures(e.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))),e.lastsuccessfulstage&&(I=e.lastsuccessfulstage,A=!0,""!==I.question?(z=!0,Ve("#validatelocation").hide(),Ve("#question_button").show()):I.activitysolved?(Ve("#validatelocation").show(),Ve("#question_button").hide()):(Ve("#validatelocation").hide(),Ve("#question_button").show())),(e.firststagegeom||i)&&(R=!0);var o=Ve.mobile.pageContainer.pagecontainer("getActivePage").prop("id");!function(){if(A){Ve("#lastsuccessfulstagename").text(r.stage+":"+I.name),Ve("#lastsuccesfulstagepos").text(I.position+" / "+I.totalnumber);var e;I.clue=I.clue.replace(/color/gm,"color-disabled"),Ve("#lastsuccessfulstageclue").html(I.clue),200<I.clue.replace(/<(?:.|\n)*?>/gm,"").length?(Ve("#lastsuccessfulstageclue").truncate(200),e=' <a href="#historypage" data-transition="none" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-icon-info ui-btn-icon-notext"></a> ',Ve("#lastsuccessfulstageclue").append(e)):e=I.clue,Ve("#lastsuccessfulstagename2").text(I.name),Ve("#lastsuccesfulstagepos2").text(I.position+" / "+I.totalnumber),Ve("#lastsuccessfulstageclue2").html(I.clue),""!==I.question&&(Ve("#lastsuccessfulstageclue").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+r.question+"</a>"),Ve("#lastsuccessfulstageclue2").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+r.question+"</a>")),Ve("#collapsibleset").collapsibleset("refresh"),Ve("#infopanel").panel("open"),Ve("#lastsuccessfulstage").collapsible("expand"),A=!1}}(),ke(),Se(),"mappage"===o||("historypage"===o?Te():"questionpage"===o&&(""===I.question?Ve.mobile.pageContainer.pagecontainer("change","#mappage"):Ve.mobile.resetActivePageHeight()))}0<e.infomsg.length&&(C.forEach(function(e){t+="<p>"+e+"</p>"}),e.infomsg.forEach(function(e){C.push(e),t+="<p>"+e+"</p>"}),je("displayupdates",r.updates,t)),D||Ve("#roadended").hide(),!D&&L||(Ve("#validatelocation").hide(),Ve("#question_button").hide(),Ve("#roadended").show(),pe.setGeometry(null),p=!1,clearInterval(T),Ve("#mapplay").css("opacity","0.8"))}).fail(function(e){console.log(e),je("displayerror",r.error,e.message),clearInterval(T)})}function ke(){if(R){var e=J.getFeatures();1===e.length&&e[0].getGeometry()instanceof ze.geom.Point?be(fe,e[0].getGeometry().getCoordinates()):be(fe,null,J.getExtent()),R=!1}}function Se(){if(z){I.question=I.question.replace(/color/gm,"color-disabled"),Ve("#questionform").html("<legend>"+I.question+"</legend>");var n=1;Ve.each(I.answers,function(e,t){var o="answer"+n;t.answertext=t.answertext.replace(/color/gm,"color-disabled"),Ve("#questionform").append('<input type="radio" name="answers" id="'+o+'"value="'+t.id+'"><label for="'+o+'">'+t.answertext+"</label>"),n++}),z=!1}}function Te(){if(V){var t=Ve("#historylist");t.html(""),V=!1,0===F.length?Ve("<li>"+r.noattempts+"</li>").appendTo(t):F.forEach(function(e){Ve("<li><span class='ui-btn-icon-left "+(e.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+e.string+"</li>").appendTo(t)}),t.listview("refresh"),t.trigger("updatelayout")}}function Pe(e){var t=Ve("<li>",{"data-icon":"check",class:e.getVisible()?"checked":"unchecked"}).append(Ve("<a />",{text:e.get("name"),href:"#mappage"}).click(function(){e.setVisible(!e.getVisible())}));e.on("change:visible",function(){Ve(t).toggleClass("checked unchecked")}),t.insertAfter("#baseLayer")}var qe=new ze.Geolocation({projection:le.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});qe.on("change:position",function(){var e=this.getPosition();ce.setGeometry(e?new ze.geom.Point(e):null),this.get("center")&&(be(fe,e),this.setProperties({center:!1})),this.get("validate_location")&&(xe(!0,!1),this.setProperties({validate_location:!1})),Ve.mobile.loading("hide")}),qe.on("change:accuracyGeometry",function(){re.setGeometry(this.getAccuracyGeometry()),Ve.mobile.loading("hide")});var Ee=!1;qe.on("error",function(e){Ve.mobile.loading("hide"),qe.setProperties({user_denied:!0}),_e(e.message),e.code==e.PERMISSION_DENIED&&f&&!p&&0==Ee&&setTimeout(function(){Ve("#popupgeoloc").popup("open",{positionTo:"window"}),Ee=!0},500)}),qe.setTracking(f),se.on("select",function(e){if(1===e.selected.length)if(I.position===e.selected[0].get("stageposition")&&e.selected[0].get("geometrysolved")&&!D&&L)Ve("#infopanel").panel("open"),Ve("#lastsuccessfulstage").collapsible("expand");else{var t,o=e.selected[0].get("name"),n=e.selected[0].get("clue"),i=e.selected[0].get("info"),a="";e.selected[0].get("geometrysolved")?o&&n?(t=r.stageovercome,a=Fe(r.stagename,o),a+=Fe(r.stageclue,n)):t=r.discoveredlocation:t=r.failedlocation,i&&(a+="<p>"+i+"</p>"),je("infostage",t,a)}}),fe.on("click",function(e){var o=!1;if(fe.forEachFeatureAtPixel(fe.getEventPixel(e.originalEvent),function(e,t){if(0===e.get("stageposition")||"user_position"===e.get("name")||"user_accuracy"===e.get("name"))return!1;o=!0}),p&&!o){var t=fe.getEventCoordinate(e.originalEvent);pe.setGeometry(t?new ze.geom.Point(t):null)}}),Ve("#autocomplete").on("filterablebeforefilter",function(e,t){if(a){var o=Ve(this),n=Ve(t.input).val();o.html(""),n&&2<n.length&&(Ve.mobile.loading("show",{text:r.searching,textVisible:!0,theme:"b"}),G.geocode(n,function(e){!1===e[0]?o.html("<li data-filtertext='"+n+"'>"+r.noresults+"</li>"):Ve.each(e,function(e,t){Ve("<li data-filtertext='"+n+"'>").hide().append(Ve("<a href='#'>").text(t.totalName).append(Ve("<p>").text(t.type))).appendTo(o).click(function(){var e=[];e[0]=parseFloat(t.boundingbox[2]),e[1]=parseFloat(t.boundingbox[0]),e[2]=parseFloat(t.boundingbox[3]),e[3]=parseFloat(t.boundingbox[1]),e=ze.proj.transformExtent(e,"EPSG:4326","EPSG:3857"),be(fe,null,e),Ve("#searchpanel").panel("close")}).show()}),o.listview("refresh"),o.trigger("updatelayout"),Ve.mobile.loading("hide")}))}}),Ve("#infopanel").on("collapsibleexpand","[data-role='collapsible']",function(e,t){var o=Ve("#infopanel .ui-panel-inner");o.animate({scrollTop:parseInt(Ve(this).offset().top-o.offset().top+o.scrollTop())},500)}),Ve(document).on("popupbeforeposition",function(){var e=Ve(window).height()-200+"px";Ve('.ui-popup [data-role="content"]').css("max-height",e)}),Ve(document).on("popupafterclose",".ui-popup:not(#QRdialog):not(#popupdialog):not(#popupgeoloc)",function(){Ve(this).remove(),se.getFeatures().clear()}),Ve(document).on("click","#acceptupdates",function(){C=[]}),Ve(window).on("pagecontainershow resize",function(e,t){Ve.mobile.resetActivePageHeight();var o=Ve.mobile.pageContainer.pagecontainer("getActivePage").prop("id");"mappage"===o?"resize"===e.type?setTimeout(function(){fe.updateSize()},200):(fe.updateSize(),ke()):"historypage"===o?"pagecontainershow"===e.type&&Te():"questionpage"===o&&"pagecontainershow"===e.type&&(""===I.question?Ve.mobile.pageContainer.pagecontainer("change","#mappage"):Se())}),a&&Ve("#autolocate").on("click",function(){qe.get("user_denied")?Ve("#popupgeoloc").popup("open",{positionTo:"window"}):(position=qe.getPosition(),be(fe,position))}),Ve("#infopanel").panel({beforeclose:function(){se.getFeatures().clear()}}),Ve("#sendLocation").on("click",function(){p&&null===pe.getGeometry()?_e(r.nomarks):xe(!0,!1)}),Ve("#sendAnswer").on("click",function(e){var t=Ve("#questionform input[type='radio']:checked");L?0===t.length?(e.preventDefault(),_e(r.noanswerselected)):xe(!1,!1,t.val()):(e.preventDefault(),_e(r.timeexceeded))}),Ve("#validatelocation").on("click",function(e){return D?(e.preventDefault(),void _e(r.huntcompleted)):L?""!==I.question?(e.preventDefault(),_e(r.answerwarning),void Ve("#infopanel").panel("open")):I.activitysolved?void 0:(e.preventDefault(),_e(r.activitytoendwarning),void Ve("#infopanel").panel("open")):(e.preventDefault(),void _e(r.timeexceeded))}),!1===Ve.mobile.autoInitializePage&&(Ve("#container").show(),Ve("#loader").remove(),Ve.mobile.initializePage(),document.querySelector("meta[name=viewport]").setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"),Ve("#QRdialog").popup({beforeposition:function(e,t){Ve(this).width(.9*window.innerWidth),Ve(this).height(.9*window.innerHeight)},afteropen:function(e,t){var o=Ve(this).find("div[data-role='content']").first(),n=Ve(this).find("div[data-role='header']").first(),i=parseInt(o.css("padding-top"))+parseInt(o.css("padding-bottom"));o.css("max-height","1000px"),Ve("#previewVideoDiv").width(Ve(this).width()-i).height(Ve(this).height()-Ve("#previewQRbuttons").height()-n.height()-2*i),Ve("#previewQRvideo").show(),loadQR(Ge,Ie)},afterclose:function(e,t){unloadQR(Ie)}}));function Ge(e){Ve("#QRdialog").popup("close"),console.log(e),_e("QR code readed: "+e),xe(!1,!1,null,e)}function Ie(e){"string"==typeof e?Ve("#errorQR").text(e):(null!==e.cameras[e.camera].name&&Ve("#errorQR").text(e.cameras[e.camera].name),1<e.cameras.length?Ve("#nextcamera").show():Ve("#nextcamera").hide())}function _e(e){0<Ve(".toast").length?setTimeout(function(){_e(e)},2500):Ve("<div class='ui-loader ui-overlay-shadow  ui-corner-all toast'><p>"+e+"</p></div>").css({left:(Ve(window).width()-284)/2,top:Ve(window).height()/2}).appendTo(Ve.mobile.pageContainer).delay(2e3).fadeOut(400,function(){Ve(this).remove()})}function je(e,t,o){var n=Ve('<div data-role="header"><h2>'+t+"</h2></div>"),i=Ve('<div data-role="content" class="ui-content ui-overlay-b">'+o+"</div>"),a=Ve('<div data-role="popup" id="'+e+'"data-theme="b" data-transition="slidedown"></div>');if("infostage"===e&&Ve('<a href="#" data-rel="back" class="ui-btn ui-corner-allui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right"></a>').appendTo(n),"displayupdates"===e){Ve('<p class="center-wrapper"><a id="acceptupdates" href="#" data-rel="back"class="ui-btn center-button ui-mini ui-btn-inline">'+r.continue+"</a></p>").appendTo(i);var l={"data-dismissible":!1,"data-overlay-theme":"b"};Ve(a).attr(l)}if("displayerror"===e){Ve('<p class="center-wrapper"><a href="view.php?id='+c+'" class="ui-btn  center-button ui-mini ui-icon-forward ui-btn-inline ui-btn-icon-left"data-ajax="false">'+r.continue+"</a></p>").appendTo(i);l={"data-dismissible":!1,"data-overlay-theme":"b"};Ve(a).attr(l)}if(Ve(n).appendTo(Ve(a).appendTo(Ve.mobile.activePage).popup()).toolbar().after(i),0<(j=Ve(i).find("img")).length){Ve.mobile.loading("show"),j.one("load",function(){_++,j.length===_&&(Ce(a),_=0,clearTimeout(s),Ve.mobile.loading("hide"))});var s=setTimeout(function(){Ce(a),Ve.mobile.loading("hide")},2e3)}else Ce(a)}function Ce(e){0<Ve(".ui-popup-active").length?(Ve(".ui-popup").popup("close"),setTimeout(function(){Ve(e).popup("open",{positionTo:"window"})},1e3)):Ve(e).popup("open",{positionTo:"window"})}function Fe(e,t){return'<div class="ui-bar ui-bar-a">'+e+'</div><div class="ui-body ui-body-a">'+t+"</div>"}Ve("#nextcamera").on("click",function(){if(null!==detectedCameras){var e=getnextwebCam();_e("Give access to:"+detectedCameras[e].name)}setnextwebcam(Ie)})}});
//# sourceMappingURL=play.min.js.map
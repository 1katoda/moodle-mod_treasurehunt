require.config({baseUrl:"js",waitSeconds:15,shim:{openlayers:{exports:"OpenLayers"},"jquery.mobile-config":["jquery"],"jquery.mobile":["jquery","jquery.mobile-config"]},paths:{openlayers:"openlayers/ol",geocoderjs:"geocoder/geocoder","jquery.mobile-config":"jquery-mobile/jquery.mobile-config","jquery.mobile":"jquery-mobile/jquerymobile"}}),define(["jquery","core/notification","core/str","core/url","openlayers","core/ajax","geocoderjs","core/templates","jquery.mobile"],function(a,b,c,d,e,f,g,h){var i={playtreasurehunt:function(b,c,h,i,j,k,l){function m(a,c){var d=a.get("noriddle");if(0===d){var f=new e.style.Fill({color:"rgba(255,255,255,0.4)"}),g=new e.style.Stroke({color:"#3399CC",width:1.25}),h=new e.style.Style({image:new e.style.Circle({fill:f,stroke:g,radius:5}),fill:f,stroke:g,text:new e.style.Text({text:b.startfromhere,textAlign:"center"})});return[h]}return a.get("geometrysolved")?(T.getImage().setScale(fa.getZoom()/110),T.getText().setText(""+d),[T]):(U.getImage().setScale(fa.getZoom()/220),U.getText().setText(""+d),[U])}function n(a,b){var c=a.get("noriddle");return a.get("geometrysolved")?(V.getText().setText(""+c),[V]):(W.getText().setText(""+c),[W])}function o(c,d){c=c||!1,d=d||!1,i&&d?null!==la.getGeometry()?r(!0,!1):x(b.nomarks):(a.mobile.loading("show"),ha.setProperties({center:c,validate_location:d}),ha.setTracking(!0))}function p(a,b){var c=500,d=a.getView(),f=e.animation.pan({duration:c,source:d.getCenter()}),g=e.animation.zoom({duration:c,resolution:d.getResolution()});a.beforeRender(f,g),d.setCenter(b),d.setResolution(2.388657133911758)}function q(a,b){var c=500,d=a.getView(),f=a.getSize(),g=e.animation.pan({duration:c,source:d.getCenter()}),h=e.animation.zoom({duration:c,resolution:d.getResolution()});a.beforeRender(g,h),d.fit(b,f)}function r(c,d,g){var m=0;if(g?a.mobile.loading("show"):g=0,c){var n;n=i?la.getGeometry():ja.getGeometry(),m=_.writeGeometry(n,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),a.mobile.loading("show")}var o=f.call([{methodname:"mod_treasurehunt_user_progress",args:{treasurehuntid:h,attempttimestamp:k,roadtimestamp:l,playwithoutmove:i,groupmode:j,initialize:d,location:m,selectedanswerid:g}}]);o[0].done(function(f){console.log(f);var h="";if(P=f.roadfinished,Q=f.available,(P||!Q)&&clearInterval(B),(c||g)&&(a.mobile.loading("hide"),null!==f.status&&x(f.status.msg)),i!=f.playwithoutmove&&(i=f.playwithoutmove),j!=f.groupmode&&(j=f.groupmode),k!==f.attempttimestamp||l!==f.roadtimestamp||d){k=f.attempttimestamp,l=f.roadtimestamp,K=f.historicalattempts,L=!0,null!==f.riddles&&(aa.clear(),aa.addFeatures(_.readFeatures(f.riddles,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))),f.lastsuccessfulriddle&&(G=f.lastsuccessfulriddle,M=!0,""!==G.question&&(N=!0)),(aa.getFeatures()[0].getGeometry()instanceof e.geom.MultiPolygon||d)&&(O=!0);var m=a.mobile.pageContainer.pagecontainer("getActivePage").prop("id");"mappage"===m?(t(),s()):"historypage"===m?v():"questionpage"===m&&(""===G.question?a.mobile.pageContainer.pagecontainer("change","#mappage"):(u(),a.mobile.resetActivePageHeight()))}f.infomsg.length>0&&(J.forEach(function(a){h+="<p>"+a+"</p>"}),f.infomsg.forEach(function(a){J.push(a),h+="<p>"+a+"</p>"}),y("displayupdates",b.updates,h))}).fail(function(a){console.log(a),y("displayerror","Error",a.message),clearInterval(B)})}function s(){if(O){var a=aa.getFeatures();1===a.length&&a[0].getGeometry()instanceof e.geom.Point?setTimeout(function(){p(oa,a[0].getGeometry().getCoordinates())},500):setTimeout(function(){q(oa,aa.getExtent())},500),O=!1}}function t(){M&&(a("#lastsuccessfulriddlename").text(G.name),a("#lastsuccesfulriddlepos").text(G.number+" / "+G.totalnumber),a("#lastsuccessfulriddledescription").html(G.description),""!==G.question&&a("#lastsuccessfulriddledescription").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+b.question+"</a>"),a("#collapsibleset").collapsibleset("refresh"),a("#infopanel").panel("open"),a("#lastsuccessfulriddle").collapsible("expand"),M=!1)}function u(){if(N){a("#questionform").html("<legend>"+G.question+"</legend>");var b=1;a.each(G.answers,function(c,d){var e="answer"+b;a("#questionform").append('<input type="radio" name="answers" id="'+e+'"value="'+d.id+'"><label for="'+e+'">'+d.answertext+"</label>"),b++}),a("#questionform").enhanceWithin().controlgroup("refresh"),N=!1}}function v(){if(L){var c=a("#historylist");c.html(""),L=!1,0===K.length?a("<li>"+b.noattempts+"</li>").appendTo(c):K.forEach(function(b){a("<li><span class='ui-btn-icon-left "+(b.penalty?"ui-icon-delete failedattempt1":"ui-icon-check successfulattempt1")+"' style='position:relative'></span>"+b.string+"</li>").appendTo(c)}),c.listview("refresh"),c.trigger("updatelayout")}}function w(b){b.getLayers().forEach(function(c){var d=a("<li>",{"data-icon":"check","class":c.getVisible()?"checked":"unchecked"}).append(a("<a />",{text:c.get("name"),href:"#mappage"}).click(function(){b.getLayers().forEach(function(a){a===c?a.setVisible(!0):a.setVisible(!1)})}));c.on("change:visible",function(){a(d).toggleClass("checked unchecked")}),d.insertAfter("#baseLayer")})}function x(b){a(".toast").length>0?setTimeout(function(){x(b)},2500):a("<div class='ui-loader ui-overlay-shadow  ui-corner-all toast'><p>"+b+"</p></div>").css({left:(a(window).width()-284)/2,top:a(window).height()/2}).appendTo(a.mobile.pageContainer).delay(2e3).fadeOut(400,function(){a(this).remove()})}function y(d,e,f){var g=a('<div data-role="header"><h2>'+e+"</h2></div>"),h=a('<div data-role="content" class="ui-content ui-overlay-b">'+f+"</div>"),i=a('<div data-role="popup" id="'+d+'"data-theme="b" data-transition="slidedown"></div>');if("inforiddle"===d&&a('<a href="#" data-rel="back" class="ui-btn ui-corner-allui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right"></a>').appendTo(g),"displayupdates"===d){a('<p class="center-wrapper"><a id="acceptupdates" href="#" data-rel="back"class="ui-btn center-button ui-mini ui-btn-inline">'+b["continue"]+"</a></p>").appendTo(h);var j={"data-dismissible":!1,"data-overlay-theme":"b"};a(i).attr(j)}if("displayerror"===d){a('<p class="center-wrapper"><a href="view.php?id='+c+'" class="ui-btn  center-button ui-mini ui-icon-forward ui-btn-inline ui-btn-icon-left"data-ajax="false">'+b["continue"]+"</a></p>").appendTo(h);var j={"data-dismissible":!1,"data-overlay-theme":"b"};a(i).attr(j)}a(g).appendTo(a(i).appendTo(a.mobile.activePage).popup()).toolbar().after(h),I=a(h).find("img"),I.length>0?(a.mobile.loading("show"),I.one("load",function(){H++,I.length===H&&(z(i),H=0,a.mobile.loading("hide"))})):z(i)}function z(b){a(".ui-popup-active").length>0?(a(".ui-popup").popup("close"),setTimeout(function(){a(b).popup("open",{positionTo:"window"})},1e3)):a(b).popup("open",{positionTo:"window"})}function A(a,b){return'<div class="ui-bar ui-bar-a">'+a+'</div><div class="ui-body ui-body-a">'+b+"</div>"}var B,C=d.imageUrl("images/pergamino","treasurehunt"),D=d.imageUrl("images/fallo","treasurehunt"),E=d.imageUrl("flag-marker","treasurehunt"),F=g.createGeocoder("openstreetmap"),G={},H=0,I=0,J=[],K=[],L=!1,M=!1,N=!1,O=!1,P=!1,Q=!0,R=new e.style.Text({textAlign:"center",scale:1.3,fill:new e.style.Fill({color:"#fff"}),stroke:new e.style.Stroke({color:"#000",width:3.5})}),S=new e.style.Text({textAlign:"center",scale:1.4,fill:new e.style.Fill({color:"#fff"}),stroke:new e.style.Stroke({color:"#3399CC",width:3.5})}),T=new e.style.Style({image:new e.style.Icon({opacity:1,scale:.2,src:C}),text:R,zIndex:"Infinity"}),U=new e.style.Style({image:new e.style.Icon({anchor:[.5,.5],opacity:1,scale:.1,src:D}),text:R,zIndex:"Infinity"}),V=new e.style.Style({image:new e.style.Icon({opacity:1,scale:.29,src:C}),text:S,zIndex:"Infinity"}),W=new e.style.Style({image:new e.style.Icon({opacity:1,scale:.14,src:D}),text:S,zIndex:"Infinity"}),X=new e.style.Style({image:new e.style.Circle({radius:6,fill:new e.style.Fill({color:[0,0,0,1]}),stroke:new e.style.Stroke({color:[255,255,255,1],width:2})})}),Y=new e.style.Style({fill:new e.style.Fill({color:[255,255,255,.3]}),stroke:new e.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),Z=new e.style.Style({image:new e.style.Icon({anchor:[.5,1],opacity:1,scale:.3,src:E})}),$=[],_=new e.format.GeoJSON,aa=new e.source.Vector({projection:"EPSG:3857"}),ba=new e.layer.Vector({source:aa,style:m}),ca=new e.layer.Tile({visible:!1,source:new e.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});ca.set("name",b.aerialview);var da=new e.layer.Tile({source:new e.source.OSM});da.set("name",b.roadview);var ea=new e.layer.Group({layers:[ca,da]}),fa=new e.View({center:[0,0],zoom:2,minZoom:2}),ga=new e.interaction.Select({layers:[ba],style:n,filter:function(a,b){return 0===a.get("noriddle")?!1:!0}}),ha=new e.Geolocation({projection:fa.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:7e3},tracking:!1}),ia=new e.Feature;ia.setStyle(Y);var ja=new e.Feature;ja.setStyle(X);var ka=new e.layer.Vector({source:new e.source.Vector({features:[ia,ja]})}),la=new e.Feature;la.setGeometry(null),la.setStyle(Z);var ma=new e.layer.Vector({source:new e.source.Vector({features:[la]})});$=[ea,ba,ka,ma];var na=new e.control.Zoom({target:"navigation",className:"custom-zoom"}),oa=new e.Map({layers:$,controls:[na],target:"mapplay",view:fa});oa.addInteraction(ga),r(!1,!0),B=setInterval(function(){r(!1,!1)},2e4),w(ea),ha.on("change:position",function(){var a=this.getPosition();this.get("center")&&p(oa,a),ja.setGeometry(a?new e.geom.Point(a):null),this.get("validate_location")&&r(!0,!1)}),ha.on("change:accuracyGeometry",function(){ia.setGeometry(this.getAccuracyGeometry()),this.setTracking(!1),a.mobile.loading("hide")}),ha.on("error",function(b){a.mobile.loading("hide"),x(b.message)}),ga.on("select",function(c){if(1===c.selected.length)if(G.id===c.selected[0].getId())a("#infopanel").panel("open"),a("#lastsuccessfulriddle").collapsible("expand");else{var d,f=c.selected[0].get("name"),g=c.selected[0].get("description"),h=c.selected[0].get("info"),j="";c.selected[0].get("success")?(j=A(b.riddlename,f),d=b.discoveredriddle,j+=A(b.riddledescription,g)):d=b.failedlocation,h&&(j+="<p>"+h+"</p>"),y("inforiddle",d,j)}else if(i){var k=c.mapBrowserEvent.coordinate;la.setGeometry(k?new e.geom.Point(k):null)}}),a("#autocomplete").on("filterablebeforefilter",function(c,d){var f=a(this),g=a(d.input).val(),h="";f.html(h),g&&g.length>2&&(a.mobile.loading("show",{text:b.searching,textVisible:!0,theme:"b"}),F.geocode(g,function(c){c[0]===!1?f.html("<li data-filtertext='"+g+"'>"+b.noresults+"</li>"):a.each(c,function(b,c){a("<li data-filtertext='"+g+"'>").hide().append(a("<a href='#'>").text(c.totalName).append(a("<p>").text(c.type))).appendTo(f).click(function(){var b=[];b[0]=parseFloat(c.boundingbox[2]),b[1]=parseFloat(c.boundingbox[0]),b[2]=parseFloat(c.boundingbox[3]),b[3]=parseFloat(c.boundingbox[1]),b=e.proj.transformExtent(b,"EPSG:4326","EPSG:3857"),q(oa,b),a("#searchpanel").panel("close")}).show()}),f.listview("refresh"),f.trigger("updatelayout"),a.mobile.loading("hide")}))}),a("#infopanel").on("collapsibleexpand","[data-role='collapsible']",function(b,c){var d=a("#infopanel .ui-panel-inner");d.animate({scrollTop:parseInt(a(this).offset().top-d.offset().top+d.scrollTop())},500)}),a(document).on("popupbeforeposition",function(){var b=a(window).height()-200+"px";a('.ui-popup [data-role="content"]').css("max-height",b)}),a(document).on("popupafterclose",".ui-popup:not(#popupDialog)",function(){a(this).remove(),ga.getFeatures().clear()}),a(document).on("click","#acceptupdates",function(){J=[]}),a(window).on("pagecontainershow resize",function(b,c){a.mobile.resetActivePageHeight();var d=a.mobile.pageContainer.pagecontainer("getActivePage").prop("id");"mappage"===d?"resize"===b.type?setTimeout(function(){oa.updateSize()},200):(oa.updateSize(),t(),s()):"historypage"===d?"pagecontainershow"===b.type&&v():"questionpage"===d&&"pagecontainershow"===b.type&&(""===G.question?(a.mobile.pageContainer.pagecontainer("change","#mappage"),x("no existe la pregunta")):u())}),a("#autolocate").on("click",function(){o(!0)}),a("#infopanel").panel({beforeclose:function(){ga.getFeatures().clear()}}),a("#sendLocation").on("click",function(){o(!1,!0)}),a("#sendAnswer").on("click",function(b){var c=a("#questionform input[type='radio']:checked");Q?0===c.length?(b.preventDefault(),x("Debes seleccionar una respuesta")):r(!1,!1,c.val()):(b.preventDefault(),x("Se ha superado el tiempo de entrega"))}),a("#validateLocation").on("click",function(b){return P?(b.preventDefault(),void x("Ya has completado esta caza del tesoro")):Q?""!==G.question?(b.preventDefault(),x("Debes responder primero a la pregunta"),void a("#infopanel").panel("open")):0===G.completion?(b.preventDefault(),x("Debes completar primero la actividad a resolver"),void a("#infopanel").panel("open")):void 0:(b.preventDefault(),void x("Se ha superado el tiempo de entrega"))}),a.mobile.autoInitializePage===!1&&(a("#container").show(),a("#loader").remove(),a.mobile.initializePage())}};return i});
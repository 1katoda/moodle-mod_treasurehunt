define(["jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/jquery.mobile-config","mod_treasurehunt/jquerymobile"],function(a,b,c,d,e){var f={playtreasurehunt:function(f,g,h,i,j,k,l,m,n){function o(a,b){var d=a.get("stageposition");if(0===d){var e=new c.style.Fill({color:"rgba(255,255,255,0.4)"}),g=new c.style.Stroke({color:"#3399CC",width:1.25}),h=new c.style.Style({image:new c.style.Circle({fill:e,stroke:g,radius:5}),fill:e,stroke:g,text:new c.style.Text({text:f.startfromhere,textAlign:"center",fill:new c.style.Fill({color:"rgb(255,255,255)"}),stroke:new c.style.Stroke({color:"#3399CC",width:5})})});return[h]}return a.get("geometrysolved")?(W.getImage().setScale(ia.getZoom()/110),W.getText().setText(""+d),[W]):(X.getImage().setScale(ia.getZoom()/50),X.getText().setText(""+d),[X])}function p(a,b){var c=a.get("stageposition");return a.get("geometrysolved")?(Y.getText().setText(""+c),[Y]):(Z.getText().setText(""+c),[Z])}function q(){i&&null==na.getGeometry()?z(f.nomarks):t(!0,!1)}function r(){position=ra.getPosition(),s(qa,position)}function s(a,b,c){var d=700,e=a.getView();c?e.fit(c,{duration:d}):e.animate({zoom:19,center:b,duration:d})}function t(b,c,e){var g,m,o;o=i?na.getGeometry():la.getGeometry(),o&&(m=ca.writeGeometryObject(o,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),e&&a.mobile.loading("show"),b&&(g=m,a.mobile.loading("show"));var p=d.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:{treasurehuntid:h,attempttimestamp:k,roadtimestamp:l,playwithoutmoving:i,groupmode:j,initialize:c,location:g,currentposition:n&&!i?m:void 0,selectedanswerid:e,qoaremoved:T}}}]);p[0].done(function(d){console.log(d);var g="";if(T=d.qoaremoved,R=d.roadfinished,S=d.available,(b||e)&&(a.mobile.loading("hide"),null!==d.status&&S&&z(d.status.msg)),i!=d.playwithoutmoving&&(i=d.playwithoutmoving,i||na.setGeometry(null)),j!=d.groupmode&&(j=d.groupmode),k!==d.attempttimestamp||l!==d.roadtimestamp||c||!S){k=d.attempttimestamp,l=d.roadtimestamp,d.historicalattempts.length>0&&(M=d.historicalattempts,N=!0),(d.attempts||d.firststagegeom)&&(da.clear(),d.firststagegeom&&da.addFeatures(ca.readFeatures(d.firststagegeom,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),d.attempts.features.length>0&&da.addFeatures(ca.readFeatures(d.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))),d.lastsuccessfulstage&&(I=d.lastsuccessfulstage,O=!0,""!==I.question?(P=!0,a("#validatelocation").hide(),a("#question_button").show()):I.activitysolved?(a("#validatelocation").show(),a("#question_button").hide()):(a("#validatelocation").hide(),a("#question_button").show())),(d.firststagegeom||c)&&(Q=!0);var h=a.mobile.pageContainer.pagecontainer("getActivePage").prop("id");"mappage"===h?(v(),u()):"historypage"===h?x():"questionpage"===h&&(""===I.question?a.mobile.pageContainer.pagecontainer("change","#mappage"):(w(),a.mobile.resetActivePageHeight()))}d.infomsg.length>0&&(L.forEach(function(a){g+="<p>"+a+"</p>"}),d.infomsg.forEach(function(a){L.push(a),g+="<p>"+a+"</p>"}),A("displayupdates",f.updates,g)),R||a("#roadended").hide(),!R&&S||(a("#validatelocation").hide(),a("#question_button").hide(),a("#roadended").show(),na.setGeometry(null),i=!1,clearInterval(D),a("#mapplay").css("opacity","0.6"))}).fail(function(a){console.log(a),A("displayerror",f.error,a.message),clearInterval(D)})}function u(){if(Q){var a=da.getFeatures();1===a.length&&a[0].getGeometry()instanceof c.geom.Point?s(qa,a[0].getGeometry().getCoordinates()):s(qa,null,da.getExtent()),Q=!1}}function v(){O&&(a("#lastsuccessfulstagename").text(I.name),a("#lastsuccesfulstagepos").text(I.position+" / "+I.totalnumber),a("#lastsuccessfulstageclue").html(I.clue),""!==I.question&&a("#lastsuccessfulstageclue").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+f.question+"</a>"),a("#collapsibleset").collapsibleset("refresh"),a("#infopanel").panel("open"),a("#lastsuccessfulstage").collapsible("expand"),O=!1)}function w(){if(P){a("#questionform").html("<legend>"+I.question+"</legend>");var b=1;a.each(I.answers,function(c,d){var e="answer"+b;a("#questionform").append('<input type="radio" name="answers" id="'+e+'"value="'+d.id+'"><label for="'+e+'">'+d.answertext+"</label>"),b++}),a("#questionform").enhanceWithin().controlgroup("refresh"),P=!1}}function x(){if(N){var b=a("#historylist");b.html(""),N=!1,0===M.length?a("<li>"+f.noattempts+"</li>").appendTo(b):M.forEach(function(c){a("<li><span class='ui-btn-icon-left "+(c.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+c.string+"</li>").appendTo(b)}),b.listview("refresh"),b.trigger("updatelayout")}}function y(b){b.getLayers().forEach(function(c){var d=a("<li>",{"data-icon":"check",class:c.getVisible()?"checked":"unchecked"}).append(a("<a />",{text:c.get("name"),href:"#mappage"}).click(function(){b.getLayers().forEach(function(a){a===c?a.setVisible(!0):a.setVisible(!1)})}));c.on("change:visible",function(){a(d).toggleClass("checked unchecked")}),d.insertAfter("#baseLayer")})}function z(b){a(".toast").length>0?setTimeout(function(){z(b)},2500):a("<div class='ui-loader ui-overlay-shadow  ui-corner-all toast'><p>"+b+"</p></div>").css({left:(a(window).width()-284)/2,top:a(window).height()/2}).appendTo(a.mobile.pageContainer).delay(2e3).fadeOut(400,function(){a(this).remove()})}function A(b,c,d){var e=a('<div data-role="header"><h2>'+c+"</h2></div>"),h=a('<div data-role="content" class="ui-content ui-overlay-b">'+d+"</div>"),i=a('<div data-role="popup" id="'+b+'"data-theme="b" data-transition="slidedown"></div>');if("infostage"===b&&a('<a href="#" data-rel="back" class="ui-btn ui-corner-allui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right"></a>').appendTo(e),"displayupdates"===b){a('<p class="center-wrapper"><a id="acceptupdates" href="#" data-rel="back"class="ui-btn center-button ui-mini ui-btn-inline">'+f.continue+"</a></p>").appendTo(h);var j={"data-dismissible":!1,"data-overlay-theme":"b"};a(i).attr(j)}if("displayerror"===b){a('<p class="center-wrapper"><a href="view.php?id='+g+'" class="ui-btn  center-button ui-mini ui-icon-forward ui-btn-inline ui-btn-icon-left"data-ajax="false">'+f.continue+"</a></p>").appendTo(h);var j={"data-dismissible":!1,"data-overlay-theme":"b"};a(i).attr(j)}if(a(e).appendTo(a(i).appendTo(a.mobile.activePage).popup()).toolbar().after(h),K=a(h).find("img"),K.length>0){a.mobile.loading("show"),K.one("load",function(){J++,K.length===J&&(B(i),J=0,clearTimeout(k),a.mobile.loading("hide"))});var k=setTimeout(function(){B(i),a.mobile.loading("hide")},2e3)}else B(i)}function B(b){a(".ui-popup-active").length>0?(a(".ui-popup").popup("close"),setTimeout(function(){a(b).popup("open",{positionTo:"window"})},1e3)):a(b).popup("open",{positionTo:"window"})}function C(a,b){return'<div class="ui-bar ui-bar-a">'+a+'</div><div class="ui-body ui-body-a">'+b+"</div>"}var D,E=b.imageUrl("parchment","treasurehunt"),F=b.imageUrl("failure","treasurehunt"),G=b.imageUrl("flagmarker","treasurehunt"),H=e.createGeocoder("openstreetmap"),I={},J=0,K=0,L=[],M=[],N=!1,O=!1,P=!1,Q=!1,R=!1,S=!0,T=!1,U=new c.style.Text({textAlign:"center",scale:1.3,fill:new c.style.Fill({color:"#fff"}),stroke:new c.style.Stroke({color:"#000",width:3.5})}),V=new c.style.Text({textAlign:"center",scale:1.4,fill:new c.style.Fill({color:"#fff"}),stroke:new c.style.Stroke({color:"#3399CC",width:3.5})}),W=new c.style.Style({image:new c.style.Icon({opacity:1,scale:.2,src:E}),text:U,zIndex:"Infinity"}),X=new c.style.Style({image:new c.style.Icon({anchor:[.2,.2],opacity:1,scale:1,src:F}),text:U,zIndex:"Infinity"}),Y=new c.style.Style({image:new c.style.Icon({opacity:1,scale:.29,src:E}),text:V,zIndex:"Infinity"}),Z=new c.style.Style({image:new c.style.Icon({anchor:[.2,.2],opacity:1,scale:.6,src:F}),text:V,zIndex:"Infinity"}),$=new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[0,0,0,1]}),stroke:new c.style.Stroke({color:[255,255,255,1],width:2})})}),_=new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.3]}),stroke:new c.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),aa=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.3,src:G})}),ba=[],ca=new c.format.GeoJSON,da=new c.source.Vector({projection:"EPSG:3857"}),ea=new c.layer.Vector({source:da,style:o}),fa=new c.layer.Tile({visible:!1,source:new c.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});fa.set("name",f.aerialview);var ga=new c.layer.Tile({source:new c.source.OSM});ga.set("name",f.roadview);var ha=new c.layer.Group({layers:[fa,ga]}),ia=new c.View({center:[0,0],zoom:2,minZoom:2}),ja=new c.interaction.Select({layers:[ea],style:p,filter:function(a,b){return 0!==a.get("stageposition")}}),ka=new c.Feature;ka.setProperties({name:"user_accuracy"}),ka.setStyle(_);var la=new c.Feature;la.setProperties({name:"user_position"}),la.setStyle($);var ma=new c.layer.Vector({source:new c.source.Vector({features:[ka,la]})}),na=new c.Feature;na.setGeometry(null),na.setStyle(aa);var oa=new c.layer.Vector({source:new c.source.Vector({features:[na]})});ba=[ha,ea,ma,oa];var pa=new c.control.Zoom({target:"navigation",className:"custom-zoom"}),qa=new c.Map({layers:ba,controls:[pa],target:"mapplay",view:ia});qa.addInteraction(ja),t(!1,!0),D=setInterval(function(){t(!1,!1)},m),y(ha);var ra=new c.Geolocation({projection:ia.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});if(ra.on("change:position",function(){var b=this.getPosition();la.setGeometry(b?new c.geom.Point(b):null),this.get("center")&&(s(qa,b),this.setProperties({center:!1})),this.get("validate_location")&&(t(!0,!1),this.setProperties({validate_location:!1})),a.mobile.loading("hide")}),ra.on("change:accuracyGeometry",function(){ka.setGeometry(this.getAccuracyGeometry()),a.mobile.loading("hide")}),ra.on("error",function(b){a.mobile.loading("hide"),ra.setProperties({user_denied:!0}),z(b.message),b.code==b.PERMISSION_DENIED&&n&&!i&&setInterval(function(){a("#popupgeoloc").popup("open",{positionTo:"window"})},500)}),ra.setTracking(n),ja.on("select",function(b){if(1===b.selected.length)if(I.position===b.selected[0].get("stageposition")&&b.selected[0].get("geometrysolved")&&!R&&S)a("#infopanel").panel("open"),a("#lastsuccessfulstage").collapsible("expand");else{var c,d=b.selected[0].get("name"),e=b.selected[0].get("clue"),g=b.selected[0].get("info"),h="";b.selected[0].get("geometrysolved")?d&&e?(c=f.stageovercome,h=C(f.stagename,d),h+=C(f.stageclue,e)):c=f.discoveredlocation:c=f.failedlocation,g&&(h+="<p>"+g+"</p>"),A("infostage",c,h)}}),qa.on("click",function(a){var b=!1;if(qa.forEachFeatureAtPixel(qa.getEventPixel(a.originalEvent),function(a,c){return 0!==a.get("stageposition")&&"user_position"!==a.get("name")&&"user_accuracy"!==a.get("name")&&void(b=!0)}),i&&!b){var d=qa.getEventCoordinate(a.originalEvent);na.setGeometry(d?new c.geom.Point(d):null)}}),a("#autocomplete").on("filterablebeforefilter",function(b,d){var e=a(this),g=a(d.input).val(),h="";e.html(h),g&&g.length>2&&(a.mobile.loading("show",{text:f.searching,textVisible:!0,theme:"b"}),H.geocode(g,function(b){b[0]===!1?e.html("<li data-filtertext='"+g+"'>"+f.noresults+"</li>"):a.each(b,function(b,d){a("<li data-filtertext='"+g+"'>").hide().append(a("<a href='#'>").text(d.totalName).append(a("<p>").text(d.type))).appendTo(e).click(function(){var b=[];b[0]=parseFloat(d.boundingbox[2]),b[1]=parseFloat(d.boundingbox[0]),b[2]=parseFloat(d.boundingbox[3]),b[3]=parseFloat(d.boundingbox[1]),b=c.proj.transformExtent(b,"EPSG:4326","EPSG:3857"),s(qa,null,b),a("#searchpanel").panel("close")}).show()}),e.listview("refresh"),e.trigger("updatelayout"),a.mobile.loading("hide")}))}),a("#infopanel").on("collapsibleexpand","[data-role='collapsible']",function(b,c){var d=a("#infopanel .ui-panel-inner");d.animate({scrollTop:parseInt(a(this).offset().top-d.offset().top+d.scrollTop())},500)}),a(document).on("popupbeforeposition",function(){var b=a(window).height()-200+"px";a('.ui-popup [data-role="content"]').css("max-height",b)}),a(document).on("popupafterclose",".ui-popup:not(#popupdialog)",function(){a(this).remove(),ja.getFeatures().clear()}),a(document).on("click","#acceptupdates",function(){L=[]}),a(window).on("pagecontainershow resize",function(b,c){a.mobile.resetActivePageHeight();var d=a.mobile.pageContainer.pagecontainer("getActivePage").prop("id");"mappage"===d?"resize"===b.type?setTimeout(function(){qa.updateSize()},200):(qa.updateSize(),v(),u()):"historypage"===d?"pagecontainershow"===b.type&&x():"questionpage"===d&&"pagecontainershow"===b.type&&(""===I.question?a.mobile.pageContainer.pagecontainer("change","#mappage"):w())}),a("#autolocate").on("click",function(){ra.get("user_denied")?a("#popupgeoloc").popup("open",{positionTo:"window"}):r(!0)}),a("#infopanel").panel({beforeclose:function(){ja.getFeatures().clear()}}),a("#sendLocation").on("click",function(){q(!0)}),a("#sendAnswer").on("click",function(b){var c=a("#questionform input[type='radio']:checked");S?0===c.length?(b.preventDefault(),z(f.noanswerselected)):t(!1,!1,c.val()):(b.preventDefault(),z(f.timeexceeded))}),a("#validatelocation").on("click",function(b){return R?(b.preventDefault(),void z(f.huntcompleted)):S?""!==I.question?(b.preventDefault(),z(f.answerwarning),void a("#infopanel").panel("open")):I.activitysolved?void 0:(b.preventDefault(),z(f.activitytoendwarning),void a("#infopanel").panel("open")):(b.preventDefault(),void z(f.timeexceeded))}),a.mobile.autoInitializePage===!1){a("#container").show(),a("#loader").remove(),a.mobile.initializePage();var sa=document.querySelector("meta[name=viewport]");sa.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0,target-densitydpi=medium-dpi")}}};return f});
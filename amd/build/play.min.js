require.config({baseUrl:"js",shim:{openlayers:{exports:"OpenLayers"},"jquery.mobile-config":["jquery"],"jquery.mobile":["jquery","jquery.mobile-config"]},paths:{openlayers:"openlayers/ol-debug",geocoderjs:"geocoder/geocoder","jquery.mobile-config":"jquery-mobile/jquery.mobile-config","jquery.mobile":"jquery-mobile/jquerymobile"}}),define(["jquery","core/notification","core/str","core/url","openlayers","jqueryui","core/ajax","geocoderjs","core/templates","jquery.mobile-config","jquery.mobile"],function(a,b,c,d,e,f,g,h,i){var j={playScavengerhunt:function(b,c,f){function i(a,b){var c=a.get("numRiddle");if(0===c){var d=new e.style.Fill({color:"rgba(255,255,255,0.4)"}),f=new e.style.Stroke({color:"#3399CC",width:1.25}),g=new e.style.Style({image:new e.style.Circle({fill:d,stroke:f,radius:5}),fill:d,stroke:f,text:new e.style.Text({text:"Solo puedes empezar desde aqui",textAlign:"center"})});return[g]}return a.get("success")?(B.getImage().setScale(L.getZoom()/110),B.getText().setText(""+c),[B]):(C.getImage().setScale(L.getZoom()/220),C.getText().setText(""+c),[C])}function j(a,b){var c=a.get("numRiddle");return a.get("success")?(D.getText().setText(""+c),[D]):(E.getText().setText(""+c),[E])}function k(b,c){b=b||!1,c=c||!1,f&&c?null!==R.getGeometry()?o():s("Marca primero en el mapa el punto deseado"):(a.mobile.loading("show"),N.setProperties({center:b,validateLocation:c}),N.setTracking(!0))}function l(b){var c=new Date(1e3*b.get("date"));b.get("success")?(a("#nameRiddle").html(b.get("name")),a("#descriptionRiddle").html(b.get("description")),a("#timeLabel").html(c.toLocaleString())):(a("#nameFailedRiddle").html(b.get("name")),a("#timeLabelFailed").html(c.toLocaleString()),a("#infoFailedLocation").show(),a("#infoRiddle").hide()),a("#infoRiddle").trigger("updatelayout"),a("#popupInfoRiddle").popup("open")}function m(a,b){var c=500,d=a.getView(),f=e.animation.pan({duration:c,source:d.getCenter()}),g=e.animation.zoom({duration:c,resolution:d.getResolution()});a.beforeRender(f,g),d.setCenter(b),d.setResolution(2.388657133911758)}function n(a,b){var c=500,d=a.getView(),f=a.getSize(),g=e.animation.pan({duration:c,source:d.getCenter()}),h=e.animation.zoom({duration:c,resolution:d.getResolution()});a.beforeRender(g,h),d.fit(b,f)}function o(){var b;b=f?R.getGeometry():P.getGeometry();var d=I.writeGeometry(b,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});a.mobile.loading("show");var e=g.call([{methodname:"mod_scavengerhunt_validate_location",args:{idScavengerhunt:c,location:d}}]);e[0].done(function(b){p(),a.mobile.loading("hide"),s(b.status.msg)}).fail(function(b){a.mobile.loading("hide"),console.log(b),s(b.message)})}function p(){var a=g.call([{methodname:"mod_scavengerhunt_user_progress",args:{idScavengerhunt:c}}]);a[0].done(function(a){console.log("json: "+a.riddles),a.status.code?s(a.status.msg):u!==a.riddles&&(u=a.riddles,J.clear(),J.addFeatures(I.readFeatures(a.riddles,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),r(J))}).fail(function(a){console.log(a),t(a.message),clearInterval(V)})}function q(b){var c=a("<li>",{"data-icon":"check","class":b.getVisible()?"checked":"unchecked"}).append(a("<a />",{text:"layer.name"}).click(function(){b instanceof e.layer.Tile?U.getLayers().forEach(function(a){a instanceof e.layer.Tile&&(a===b?a.setVisible(!0):a.setVisible(!1))}):b.setVisible(!b.getVisible())}));b.on("change:visible",function(){a(c).toggleClass("checked unchecked")}),b instanceof e.layer.Tile?c.insertAfter("#baseLayer"):c.insertAfter("#overlayLayer")}function r(b){a("#infoRiddles").not(":first").remove(),b.forEachFeature(function(b){if(b.get("success")){var c="<div data-role='collapsible' data-collapsed-icon='carat-d' data-expanded-icon='carat-u' id='riddle"+b.getId()+"'><h3><span class='ui-body-b'>"+b.get("numRiddle")+"</span> "+b.get("name")+"</h3><p>"+b.get("description")+"</p></div>";a("#infoRiddles").append(c)}}),a("#infoRiddles").collapsibleset("refresh")}function s(b){a("<div class='ui-loader ui-overlay-shadow  ui-corner-all' style='background-color:black;'><p>"+b+"</p></div>").css({display:"block",opacity:.9,position:"fixed",padding:"7px","text-align":"center",width:"270px",left:(a(window).width()-284)/2,top:a(window).height()/2}).appendTo(a.mobile.pageContainer).delay(1500).fadeOut(400,function(){a(this).remove()})}function t(c){var d=a("<div/>").popup({dismissible:!1,theme:"b",overlyaTheme:"e",transition:"pop"}).on("popupafterclose",function(){window.location.replace("view.php?id="+b),a(this).remove()}).css({width:"270px",height:"200px",padding:"5px"});a("<h2/>",{text:"Error"}).appendTo(d),a("<p/>",{text:c}).appendTo(d),a("<a>",{text:"Continue"}).buttonMarkup({inline:!1,mini:!0,icon:"forward"}).on("click",function(){d.popup("close")}).appendTo(d),d.popup("open").trigger("create")}var u,v=d.imageUrl("images/pergamino","scavengerhunt"),w=d.imageUrl("images/fallo","scavengerhunt"),x=d.imageUrl("flag-marker","scavengerhunt"),y=h.createGeocoder("openstreetmap"),z=new e.style.Text({textAlign:"center",scale:1.3,fill:new e.style.Fill({color:"#fff"}),stroke:new e.style.Stroke({color:"#000",width:3.5})}),A=new e.style.Text({textAlign:"center",scale:1.4,fill:new e.style.Fill({color:"#fff"}),stroke:new e.style.Stroke({color:"#3399CC",width:3.5})}),B=new e.style.Style({image:new e.style.Icon({opacity:1,scale:.2,src:v}),text:z,zIndex:"Infinity"}),C=new e.style.Style({image:new e.style.Icon({anchor:[.5,.5],opacity:1,scale:.1,src:w}),text:z,zIndex:"Infinity"}),D=new e.style.Style({image:new e.style.Icon({opacity:1,scale:.29,src:v}),text:A,zIndex:"Infinity"}),E=new e.style.Style({image:new e.style.Icon({opacity:1,scale:.14,src:w}),text:A,zIndex:"Infinity"}),F=new e.style.Style({image:new e.style.Circle({radius:6,fill:new e.style.Fill({color:[0,0,0,1]}),stroke:new e.style.Stroke({color:[255,255,255,1],width:2})})}),G=new e.style.Style({fill:new e.style.Fill({color:[255,255,255,.3]}),stroke:new e.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),H=new e.style.Style({image:new e.style.Icon({anchor:[.5,1],opacity:1,scale:.3,src:x})}),I=new e.format.GeoJSON,J=new e.source.Vector({projection:"EPSG:3857"}),K=new e.layer.Vector({source:J,style:i}),L=new e.View({center:[0,0],zoom:2,minZoom:2}),M=new e.interaction.Select({layers:[K],style:j,filter:function(a,b){return 0===a.get("numRiddle")?!1:!0}}),N=new e.Geolocation({projection:L.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:7e3},tracking:!1}),O=new e.Feature;O.setStyle(G);var P=new e.Feature;P.setStyle(F);var Q=new e.layer.Vector({source:new e.source.Vector({features:[O,P]})}),R=new e.Feature;R.setGeometry(null),R.setStyle(H);var S=new e.layer.Vector({source:new e.source.Vector({features:[R]})}),T=new e.control.Zoom({target:"navigation",className:"custom-zoom"}),U=new e.Map({layers:[new e.layer.Tile({visible:!1,source:new e.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new e.layer.Tile({source:new e.source.OSM}),K,Q,S],controls:[T],target:"map",view:L});U.addInteraction(M),p();var V=setInterval(function(){p()},2e4);N.on("change:position",function(){var a=this.getPosition();this.get("center")&&m(U,a),P.setGeometry(a?new e.geom.Point(a):null),this.get("validateLocation")&&o()}),N.on("change:accuracyGeometry",function(){O.setGeometry(this.getAccuracyGeometry()),this.setTracking(!1),a.mobile.loading("hide")}),N.on("error",function(b){a.mobile.loading("hide"),s(b.message)}),M.on("select",function(a){if(1===a.selected.length)l(a.selected[0]);else{var b=a.mapBrowserEvent.coordinate;R.setGeometry(b?new e.geom.Point(b):null)}}),U.getLayers().forEach(function(a,b){q(a)}),a("#autocomplete").on("filterablebeforefilter",function(b,c){var d=a(this),f=a(c.input).val(),g="";d.html(g),f&&f.length>2?(a.mobile.loading("show",{text:"Buscando",textVisible:!0}),y.geocode(f,function(b){b[0]===!1?d.html("<li data-filtertext='"+f+"'>No hay resultados</li>"):a.each(b,function(b,c){a("<li data-filtertext='"+f+"'>").hide().append(a("<a href='#'>").text(c.totalName).append(a("<p>").text(c.type))).appendTo(d).click(function(){var b=[];b[0]=parseFloat(c.boundingbox[2]),b[1]=parseFloat(c.boundingbox[0]),b[2]=parseFloat(c.boundingbox[3]),b[3]=parseFloat(c.boundingbox[1]),b=e.proj.transformExtent(b,"EPSG:4326","EPSG:3857"),n(U,b),a("#searchpanel").panel("close")}).show()}),d.listview("refresh"),d.trigger("updatelayout"),a.mobile.loading("hide")})):a.mobile.resetActivePageHeight()}),a("#popupInfoRiddle").on({popupbeforeposition:function(){var b=a(window).height()-120;a("#popupInfoRiddle").css("max-height",b+"px")}}),a(document).on("pagecontainershow",function(b,c){var d=a(":mobile-pagecontainer").pagecontainer("getActivePage").prop("id");"mappage"===d&&U instanceof e.Map&&U.updateSize()}),a("#autolocate").on("click",function(){k(!0)}),a("#infopanel").panel({beforeclose:function(){M.getFeatures().clear()}}),a("#popupInfoRiddle").on("popupafterclose",function(){M.getFeatures().clear()}),a("#sendLocation").on("click",function(){k(!1,!0)}),a.mobile.autoInitializePage===!1&&(a("#container").show(),a.mobile.initializePage())}};return j});
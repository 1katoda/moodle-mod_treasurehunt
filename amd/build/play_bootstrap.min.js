/**
 * @module    mod_treasurehunt/play
 * @package   mod_treasurehunt
 * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>, Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @author Adrian Rodriguez <huorwhisp@gmail.com>
 * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/osm-geocoder","mod_treasurehunt/viewgpx","core/str","mod_treasurehunt/webqr","mod_treasurehunt/jquery.truncate"],(function(e,t,a,o,s,l,i,n){return{playtreasurehunt:function(e,t,a,o,s,l,n,c,d,u){let m=["stageovercome","failedlocation","stage","stagename","stageclue","question","noanswerselected","timeexceeded","searching","continue","noattempts","aerialview","roadview","noresults","startfromhere","nomarks","updates","activitytoendwarning","huntcompleted","discoveredlocation","answerwarning","error"],g=m.map(e=>({key:e,component:"treasurehunt"}));i.get_strings(g).done(i=>{let g=[];for(let e=0;e<m.length;e++)g[m[e]]=i[e];if(void 0!==u&&u&&u.custombackgroundurl){let i=new Image;i.addEventListener("load",(function(){u.imgwidth=this.naturalWidth,u.imgheight=this.naturalHeight,r(g,e,t,a,o,s,l,n,c,d,u)})),i.src=u.custombackgroundurl}else r(g,e,t,a,o,s,l,n,c,d,u)})}};function r(i,r,c,d,u,m,g,p,y,f,h){ke(!0);let w=null,v=!0,b=15,x="ontouchstart"in window||navigator.msMaxTouchPoints;if(h){if(h.custombackgroundurl){let e=a.proj.transformExtent(h.bbox,"EPSG:4326","EPSG:3857");if(!h.geographic){let t=e[3]-e[1],a=(e[2]+e[0])/2,o=(e[3]+e[1])/2,s=Math.round(t/h.imgheight),l=Math.round(h.imgwidth*s),i=Math.round(h.imgheight*s);e=[a-l/2,o-i/2,a+l/2,o+i/2],b=5}w=new a.layer.Image({title:h.layername,name:h.layername,type:h.layertype,source:new a.source.ImageStatic({url:h.custombackgroundurl,imageExtent:e}),opacity:1})}else if(h.wmsurl){let e={source:new a.source.TileWMS({url:h.wmsurl,params:h.wmsparams}),type:h.layertype,title:h.layername,name:h.layername};if(h.bbox[0]&&h.bbox[1]&&h.bbox[2]&&h.bbox[3]){let t=a.proj.transformExtent(h.bbox,"EPSG:4326","EPSG:3857");e.extent=t}w=new a.layer.Tile(e)}v=h.geographic}!1===v&&(d=!0,e("#autolocate").hide());let k,P,S=t.imageUrl("success_mark","treasurehunt"),E=t.imageUrl("failure_mark","treasurehunt"),T=t.imageUrl("bootstrap/my_location_3","treasurehunt"),G={},C=[],I=[],_=!1,q=!1,F=!1,j=!1,V=!1,z=!0,A=!1,M=0,D=new a.style.Text({textAlign:"center",scale:1.3,fill:new a.style.Fill({color:"#ffffff"}),stroke:new a.style.Stroke({color:"#000000",width:3.5})}),L=new a.style.Text({textAlign:"center",scale:1.4,fill:new a.style.Fill({color:"#fff"}),stroke:new a.style.Stroke({color:"#0097a7",width:3.5})}),R=new a.style.Style({image:new a.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:S}),text:D,zIndex:"Infinity"}),$=new a.style.Style({image:new a.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:E}),text:D,zIndex:"Infinity"}),N=new a.style.Style({image:new a.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:S}),text:L,zIndex:"Infinity"}),O=new a.style.Style({image:new a.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:E}),text:L,zIndex:"Infinity"}),Q=new a.style.Style({image:new a.style.Circle({radius:6,fill:new a.style.Fill({color:[0,0,0,1]}),stroke:new a.style.Stroke({color:[255,255,255,1],width:2})})}),W=new a.style.Style({fill:new a.style.Fill({color:[255,255,255,.3]}),stroke:new a.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),B=new a.style.Style({image:new a.style.Icon({anchor:[.5,.9],opacity:1,scale:1,src:T})}),H=[],U=new a.format.GeoJSON,Z=new a.source.Vector({projection:"EPSG:3857"}),K=new a.layer.Vector({source:Z,style:function(e){let t=e.get("stageposition");if(0===t){let e=new a.style.Fill({color:"rgba(0,0,0,0.1)"}),t=new a.style.Stroke({color:"#0097a7",width:2});return[new a.style.Style({image:new a.style.Circle({fill:e,stroke:t,radius:5}),fill:e,stroke:t,text:new a.style.Text({text:i.startfromhere,textAlign:"center",fill:new a.style.Fill({color:"rgb(255,255,255)"}),stroke:new a.style.Stroke({color:"#0097a7",width:5})})})]}if(!e.get("geometrysolved"))return $.getText().setText(""+t),[$];return R.getText().setText(""+t),[R]}}),X=new a.layer.Tile({visible:!1,source:new a.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});X.set("name",i.aerialview);let Y=new a.layer.Tile({source:new a.source.OSM});Y.set("name",i.roadview);let J=[],ee=[];h&&!1!==h.onlybase||(J=[X,Y]),w&&("overlay"!=h.layertype?J.push(w):ee.push(w));let te=new a.layer.Group({layers:J}),ae=null;te.getLayers().forEach(e=>{e.setVisible(!1),ae=e}),ae.setVisible(!0);let oe=new a.View({center:[0,0],zoom:2,minZoom:2}),se=new a.interaction.Select({layers:[K],style:function(e){let t=e.get("stageposition");if(!e.get("geometrysolved"))return O.getText().setText(""+t),[O];return N.getText().setText(""+t),[N]},filter:e=>0!==e.get("stageposition")}),le=new a.Feature;le.setProperties({name:"user_accuracy"}),le.setStyle(W);let ie=new a.Feature;ie.setProperties({name:"user_position"}),ie.setStyle(Q);let ne=new a.layer.Vector({source:new a.source.Vector({features:[le,ie]})}),re=new a.Feature;re.setGeometry(null),re.setStyle(B);let ce=new a.layer.Vector({source:new a.source.Vector({features:[re]})});H.push(te),H=H.concat(ee),H=H.concat([K,ne,ce]);let de=new a.control.Zoom({target:"navigation",className:"custom-zoom"}),ue=new a.Map({layers:H,controls:[de],target:"mapplay",view:oe,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});if(ue.addInteraction(se),ge(!1,!0),k=setInterval(()=>{ge(!1,!1)},p),function(t){t.getLayers().forEach(a=>{let o=e("<button>",{type:"button",class:"list-group-item list-group-item-action close-modal"}).click(()=>{t.getLayers().forEach(e=>{e===a?e.setVisible(!0):e.setVisible(!1)})}),s=e("<div>",{text:a.get("name"),class:"layer-item "+(a.getVisible()?"":"unchecked")}).append(e("<i class='fa fa-check-circle'>"));o.append(s),a.on("change:visible",()=>{e(s).toggleClass("unchecked")}),e("#layerslist").prepend(o)})}(te),ee.forEach(e=>{pe(e)}),y&&f){let e=l.addgpxlayer(ue,r,c,i,f,"trackgroup");e.set("name",e.get("title"));let t=e.getLayers().item(0),a=t.get("title");t.set("name",a),t.setVisible(!1),pe(t)}function me(e,t,a){let o=e.getView();a?o.fit(a,{duration:700}):o.animate({zoom:b,center:t,duration:700})}function ge(t,s,l,n){let r,p,f,h;f=d?re.getGeometry():ie.getGeometry(),f&&(p=U.writeGeometryObject(f,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),l&&(ke(!0),h=l),t&&(r=p,ke(!0)),o.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:{treasurehuntid:c,attempttimestamp:m,roadtimestamp:g,playwithoutmoving:d,groupmode:u,initialize:s,location:r,currentposition:y&&!d?p:void 0,selectedanswerid:h,qoaremoved:A,qrtext:n}}}])[0].done(o=>{if(A=o.qoaremoved,V=o.roadfinished,z=o.available,ke(!1),(t||l)&&(null!==o.status&&z&&he(o.status.msg),re.setGeometry(null)),o.qrexpected?e("#validateqr").show():e("#validateqr").hide(),d!=o.playwithoutmoving&&((d=o.playwithoutmoving)||re.setGeometry(null)),u!=o.groupmode&&(u=o.groupmode),m===o.attempttimestamp&&g===o.roadtimestamp&&!s&&z||(m=o.attempttimestamp,g=o.roadtimestamp,o.attempthistory.length>0&&(I=o.attempthistory,_=!0),(o.attempts||o.firststagegeom)&&(Z.clear(),o.firststagegeom&&Z.addFeatures(U.readFeatures(o.firststagegeom,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),o.attempts.features.length>0&&Z.addFeatures(U.readFeatures(o.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))),o.lastsuccessfulstage&&(G=o.lastsuccessfulstage,q=!0,we("#cluepage"),""!==G.question?(F=!0,e("#validatelocation").hide()):G.activitysolved?e("#validatelocation").show():e("#validatelocation").hide()),(o.firststagegeom||s)&&(j=!0),q&&(G.clue=G.clue.replace(/color/gm,"color-disabled"),e("#lastsuccessfulstageclue").html(G.clue),e("#lastsuccessfulstagename").text(G.name),e("#lastsuccesfulstagepos").text(G.position+" / "+G.totalnumber),""!==G.question?e("#questionbutton").show():e("#questionbutton").hide(),q=!1),function(){if(j){let e=Z.getFeatures();1===e.length&&e[0].getGeometry()instanceof a.geom.Point?me(ue,e[0].getGeometry().getCoordinates()):me(ue,null,Z.getExtent()),j=!1}}(),function(){if(F){G.question=G.question.replace(/color/gm,"color-disabled"),e("#questionform").html("<legend>"+G.question+"</legend>");let t=1;e.each(G.answers,(a,o)=>{let s="answer"+t;o.answertext=o.answertext.replace(/color/gm,"color-disabled"),e("#questionform").append(`<div class="form-check">\n                <input class="form-check-input" type="radio" name="answers" id="${s}" value="${o.id}">\n                <label class="form-check-label" for="${s}">\n                  ${o.answertext}\n                </label>\n            </div>`),t++}),F=!1}}(),function(){if(_){let t=e("#historylist");t.html(""),_=!1,0===I.length?e("<li>"+i.noattempts+"</li>").appendTo(t):I.forEach(a=>{e("<li><span class='ui-btn-icon-left "+(a.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+a.string+"</li>").appendTo(t)})}}()),o.infomsg.length>0){let t="";C.forEach(e=>{t+="<p>"+e+"</p>"}),o.infomsg.forEach(e=>{C.push(e),t+="<p>"+e+"</p>"}),e("#notificationsPopup .update-list").html(t),we("#notificationsPopup")}V||e("#roadended").hide(),!V&&z||(e("#validatelocation").hide(),e("#question_button").hide(),e("#roadended").show(),re.setGeometry(null),d=!1,clearInterval(k),e("#mapplay").css("opacity","0.8"))}).fail(t=>{e("#errorPopup .play-modal-content").text(t.message),we("#errorPopup"),clearInterval(k)})}function pe(t){let a=e("<button>",{type:"button",class:"list-group-item list-group-item-action close-modal"}).click(()=>{t.setVisible(!t.getVisible())}),o=jQuery.parseHTML(t.get("name")),s=e("<div>",{class:"layer-item "+(t.getVisible()?"":"unchecked")}).append(o,e("<i class='fa fa-check-circle'>"));a.append(s),t.on("change:visible",()=>{e(s).toggleClass("unchecked")}),e("#layerslist").prepend(a)}let ye=new a.Geolocation({projection:oe.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});ye.on("change:position",()=>{let e=ye.getPosition();ie.setGeometry(e?new a.geom.Point(e):null),ye.get("center")&&(me(ue,e),ye.setProperties({center:!1})),ye.get("validate_location")&&(ge(!0,!1),ye.setProperties({validate_location:!1}))}),ye.on("change:accuracyGeometry",()=>{le.setGeometry(ye.getAccuracyGeometry())});let fe=!1;function he(t){const a=e(`<div class='play-toast slide-in-bottom'>${t}</div>`);a.appendTo(e(".play-toast-container")),setTimeout(()=>a.addClass("slide-out-top"),3e3),setTimeout(()=>a.remove(),3500)}function we(t){ve();const a=e(t);a.trigger("modal:open"),a.addClass("active"),e(`${t} .modal-mask`).addClass("active dismissible")}function ve(){const t=e(".play-modal.active");t.trigger("modal:close"),t.removeClass("active"),e(".modal-mask").removeClass("active dismissible")}function be(e,t){return`<div class="card">\n          <div class="card-body">\n            <h5 class="card-title">${e}</h5>\n            <h6 class="card-subtitle text-muted">${t}</h6>\n          </div>\n      </div>`}function xe(t){e(t).addClass("active"),e(".sidebar-mask").addClass("active dismissible")}function ke(t){t?e(".global-loader").addClass("active"):e(".global-loader").removeClass("active")}function Pe(e){ve(),he("QR code readed: "+e),ge(!1,!1,null,e)}function Se(t){"string"==typeof t?e("#errorQR").text(t):(null!==t.cameras[t.camera].name&&e("#errorQR").text(t.cameras[t.camera].name),t.cameras.length>1?e("#nextcamera").show():e("#nextcamera").hide())}ye.on("error",t=>{ye.setProperties({user_denied:!0}),he(t.message),t.code==t.PERMISSION_DENIED&&y&&!d&&0==fe&&setTimeout(()=>{e("#popupgeoloc").popup("open",{positionTo:"window"}),fe=!0},500)}),ye.setTracking(y),x||ue.on("pointermove",e=>{if(e.dragging)return;const t=ue.getEventPixel(e.originalEvent);let o=!1;ue.forEachFeatureAtPixel(t,e=>{e.getGeometry()instanceof a.geom.MultiPolygon||(o=!0)},{layerFilter:e=>e===K}),ue.getTargetElement().style.cursor=o?"pointer":"crosshair"}),se.on("select",t=>{if(1===t.selected.length){let a=t.selected[0].get("name"),o=t.selected[0].get("clue"),s=t.selected[0].get("info"),l="",n="";s&&(l="<p>"+s+"</p>"),t.selected[0].get("geometrysolved")?a&&o?(n=i.stageovercome,l+=be(i.stagename,a),l+=be(i.stageclue,o)):n=i.discoveredlocation:n=i.failedlocation,e("#infoStagePopup .title").text(n),e("#infoStagePopup .play-modal-content").html(l),we("#infoStagePopup")}}),ue.on("click",e=>{let t=!1;if(ue.forEachFeatureAtPixel(ue.getEventPixel(e.originalEvent),e=>{if(0===e.get("stageposition")||"user_position"===e.get("name")||"user_accuracy"===e.get("name"))return!1;t=!0}),d&&!t){let t=ue.getEventCoordinate(e.originalEvent);re.setGeometry(t?new a.geom.Point(t):null)}}),e("#searchInput").on("input",t=>{P&&P.abort(),M&&clearTimeout(M);const o=e("#searchsResults"),l=t.target.value;o.html(""),l&&l.length>2&&(e(".search-loading").addClass("active"),M=setTimeout(()=>{P=s.search(l).done(t=>{e(".search-loading").removeClass("active"),0===t.length?o.html("<li class='list-group-item'>"+i.noresults+"</li>"):e.each(t,(t,s)=>{let l=e("<button>",{type:"button",class:"list-group-item list-group-item-action"}).appendTo(o).click(()=>{let t=[];t[0]=parseFloat(s.boundingbox[2]),t[1]=parseFloat(s.boundingbox[0]),t[2]=parseFloat(s.boundingbox[3]),t[3]=parseFloat(s.boundingbox[1]),t=a.proj.transformExtent(t,"EPSG:4326","EPSG:3857"),me(ue,null,t),e("#searchpanel").removeClass("active"),e(".sidebar-mask").removeClass("active dismissible")}),i=e("<div>",{text:s.display_name,class:"search-option"}).append(e("<i class='fa fa-chevron-circle-right'>"));l.append(i)})}).fail(()=>{}).always(()=>{P=null})},400))}),e("#infoStagePopup").on("modal:close",()=>{se.getFeatures().clear()}),e("#acceptupdates").on("click",()=>{C=[]}),e("#qrpage").on("modal:open",()=>{n.loadQR(Pe,Se)}),e("#qrpage").on("modal:close",()=>{n.unloadQR(Se)}),e("#nextcamera").on("click",()=>{let e=n.getDetectedCameras();if(null!==e){he("Give access to:"+e[n.getnextwebCam()].name)}n.setnextwebcam(Se)}),e(window).on("resize",()=>{ue.updateSize()}),v&&e("#autolocate").on("click",()=>{ye.get("user_denied")?e("#popupgeoloc").popup("open",{positionTo:"window"}):function(){const e=ye.getPosition();me(ue,e)}()}),e("#infopanel").on("sidebar:close",()=>{se.getFeatures().clear()}),e("#sendLocation").on("click",()=>{d&&!re.getGeometry()?he(i.nomarks):ge(!0,!1)}),e("#sendAnswer").on("click",t=>{let a=e("#questionform input[type='radio']:checked");z?0===a.length?(t.preventDefault(),he(i.noanswerselected)):ge(!1,!1,a.val()):(t.preventDefault(),he(i.timeexceeded))}),e("#validatelocation").on("click",e=>V?(e.preventDefault(),void he(i.huntcompleted)):z?""!==G.question?(e.preventDefault(),he(i.answerwarning),void xe("#infopanel")):G.activitysolved?void 0:(e.preventDefault(),he(i.activitytoendwarning),void xe("#infopanel")):(e.preventDefault(),void he(i.timeexceeded))),e(document).on("click",'*[data-rel="sidebar"]',t=>{const a=t.currentTarget,o=e(a.dataset.ref);o.trigger("sidebar:open"),o.addClass("active"),null!==a.dataset.dismissible&&e(".sidebar-mask").addClass("active dismissible")}),e(document).on("click",".close-sidebar, .sidebar-mask",()=>{const t=e(".sidebar.active");t.trigger("sidebar:close"),t.removeClass("active"),e(".sidebar-mask").removeClass("active dismissible")}),e(document).on("click",'*[data-rel="modal"]',t=>{ve();const a=t.currentTarget,o=e(a.dataset.ref);o.trigger("modal:open"),o.addClass("active"),e(a.dataset.ref+" .modal-mask").addClass("active"),null!==a.dataset.dismissible&&e(a.dataset.ref+" .modal-mask").addClass("dismissible")}),e(document).on("click",".close-modal, .modal-mask.dismissible",()=>{ve()})}}));
"use strict";define(["jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/osm-geocoder","mod_treasurehunt/viewgpx","core/str","mod_treasurehunt/webqr","mod_treasurehunt/jquery.truncate","mod_treasurehunt/dropdown"],function(je,Ve,ze,Ae,Me,De,t,Le){return{playtreasurehunt:function(n,i,r,s,l,c,u,d,m,g){var p=["stageovercome","failedlocation","stage","stagename","stageclue","question","noanswerselected","timeexceeded","searching","continue","noattempts","aerialview","roadview","noresults","startfromhere","nomarks","updates","activitytoendwarning","huntcompleted","discoveredlocation","answerwarning","error","pegmanlabel"],e=p.map(function(e){return{key:e,component:"treasurehunt"}});t.get_strings(e).done(function(e){for(var t,a=[],o=0;o<p.length;o++)a[p[o]]=e[o];void 0!==g&&g&&g.custombackgroundurl?((t=new Image).addEventListener("load",function(){g.imgwidth=this.naturalWidth,g.imgheight=this.naturalHeight,f(a,n,i,r,s,l,c,u,d,m,g)}),t.src=g.custombackgroundurl):f(a,n,i,r,s,l,c,u,d,m,g)})}};function f(l,e,c,u,d,m,g,t,p,a,o){Ie(!0);var n,i,r,s,f,v,y,h,w,b="EPSG:3857",x=null,k=!0,P=15,S="ontouchstart"in window||navigator.msMaxTouchPoints;o&&(o.custombackgroundurl?(y=ze.proj.transformExtent(o.bbox,"EPSG:4326",b),o.geographic||(n=y[3]-y[1],i=(y[2]+y[0])/2,r=(y[3]+y[1])/2,s=Math.round(n/o.imgheight),y=[i-(f=Math.round(o.imgwidth*s))/2,r-(v=Math.round(o.imgheight*s))/2,i+f/2,r+v/2],P=5),x=new ze.layer.Image({title:o.layername,name:o.layername,type:o.layertype,source:new ze.source.ImageStatic({url:o.custombackgroundurl,imageExtent:y}),opacity:1})):o.wmsurl&&(h={source:new ze.source.TileWMS({url:o.wmsurl,params:o.wmsparams}),type:o.layertype,title:o.layername,name:o.layername},o.bbox[0]&&o.bbox[1]&&o.bbox[2]&&o.bbox[3]&&(w=ze.proj.transformExtent(o.bbox,"EPSG:4326",b),h.extent=w),x=new ze.layer.Tile(h)),k=o.geographic),!1===k&&(u=!0,je("#autolocate").hide());var E,T,G=Ve.imageUrl("success_mark","treasurehunt"),C=Ve.imageUrl("failure_mark","treasurehunt"),_=Ve.imageUrl("bootstrap/my_location_3","treasurehunt"),I={},q=[],F=[],j=!1,V=!1,z=!1,A=!1,M=!1,D=!0,L=!1,R=0,O=new ze.style.Text({textAlign:"center",scale:1.3,fill:new ze.style.Fill({color:"#ffffff"}),stroke:new ze.style.Stroke({color:"#000000",width:3.5})}),N=new ze.style.Text({textAlign:"center",scale:1.4,fill:new ze.style.Fill({color:"#fff"}),stroke:new ze.style.Stroke({color:"#0097a7",width:3.5})}),Q=new ze.style.Style({image:new ze.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:G}),text:O,zIndex:"Infinity"}),W=new ze.style.Style({image:new ze.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:C}),text:O,zIndex:"Infinity"}),B=new ze.style.Style({image:new ze.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:G}),text:N,zIndex:"Infinity"}),H=new ze.style.Style({image:new ze.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:C}),text:N,zIndex:"Infinity"}),U=new ze.style.Style({image:new ze.style.Circle({radius:6,fill:new ze.style.Fill({color:[0,0,0,1]}),stroke:new ze.style.Stroke({color:[255,255,255,1],width:2})})}),Z=new ze.style.Style({fill:new ze.style.Fill({color:[255,255,255,.3]}),stroke:new ze.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),K=new ze.style.Style({image:new ze.style.Icon({anchor:[.5,.9],opacity:1,scale:1,src:_})}),X=[],Y=new ze.format.GeoJSON,J=new ze.source.Vector({projection:"EPSG:3857"}),$=new ze.layer.Vector({source:J,style:function(e){var t=e.get("stageposition");if(0!==t)return e.get("geometrysolved")?(Q.getText().setText(""+t),[Q]):(W.getText().setText(""+t),[W]);var a=new ze.style.Fill({color:"rgba(0,0,0,0.1)"}),o=new ze.style.Stroke({color:"#0097a7",width:2});return[new ze.style.Style({image:new ze.style.Circle({fill:a,stroke:o,radius:5}),fill:a,stroke:o,text:new ze.style.Text({text:l.startfromhere,textAlign:"center",fill:new ze.style.Fill({color:"rgb(255,255,255)"}),stroke:new ze.style.Stroke({color:"#0097a7",width:5})})})]}}),ee=new ze.layer.Tile({visible:!1,source:new ze.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});ee.set("name",l.aerialview);var te=new ze.layer.Tile({source:new ze.source.OSM});te.set("name",l.roadview);var ae=[],oe=[];o&&!1!==o.onlybase||(ae=[ee,te]),x&&("overlay"!=o.layertype?ae.push(x):oe.push(x));var ne=new ze.layer.Group({layers:ae}),ie=De.createCoordsOverlay("#mapplay","css/playerbootstrap/ol-popup.css",l.pegmanlabel),re=null;ne.getLayers().forEach(function(e){e.setVisible(!1),re=e}),re.setVisible(!0);var se=new ze.View({center:[0,0],zoom:2,minZoom:2}),le=new ze.interaction.Select({layers:[$],style:function(e){var t=e.get("stageposition");return e.get("geometrysolved")?(B.getText().setText(""+t),[B]):(H.getText().setText(""+t),[H])},filter:function(e){return 0!==e.get("stageposition")}}),ce=new ze.Feature;ce.setProperties({name:"user_accuracy"}),ce.setStyle(Z);var ue=new ze.Feature;ue.setProperties({name:"user_position"}),ue.setStyle(U);var de=new ze.layer.Vector({source:new ze.source.Vector({features:[ce,ue]})}),me=new ze.Feature;me.setGeometry(null),me.setStyle(K);var ge=new ze.layer.Vector({source:new ze.source.Vector({features:[me]})});X.push(ne),X=(X=X.concat(oe)).concat([$,de,ge]);var pe,fe,ve,ye,he=new ze.control.Zoom({target:"navigation",className:"custom-zoom"}),we=new ze.Map({layers:X,overlays:[ie],controls:[he],target:"mapplay",view:se,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});function be(e,t,a){var o=e.getView();a?o.fit(a,{duration:700}):o.animate({zoom:P,center:t,duration:700})}function xe(a,o,n,e){var t,i,r,s=u?me.getGeometry():ue.getGeometry();s&&(i=Y.writeGeometryObject(s,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),n&&(Ie(!0),r=n),a&&(t=i,Ie(!0)),Ae.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:{treasurehuntid:c,attempttimestamp:m,roadtimestamp:g,playwithoutmoving:u,groupmode:d,initialize:o,location:t,currentposition:p&&!u?i:void 0,selectedanswerid:r,qoaremoved:L,qrtext:e}}}])[0].done(function(e){var t;L=e.qoaremoved,M=e.roadfinished,D=e.available,Ie(!1),(a||n)&&(null!==e.status&&D&&Ee(e.status.msg),me.setGeometry(null)),e.qrexpected?je("#validateqr").show():je("#validateqr").hide(),u!=e.playwithoutmoving&&((u=e.playwithoutmoving)||me.setGeometry(null)),d!=e.groupmode&&(d=e.groupmode),m===e.attempttimestamp&&g===e.roadtimestamp&&!o&&D||(m=e.attempttimestamp,g=e.roadtimestamp,0<e.attempthistory.length&&(F=e.attempthistory,j=!0),(e.attempts||e.firststagegeom)&&(J.clear(),e.firststagegeom&&J.addFeatures(Y.readFeatures(e.firststagegeom,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),0<e.attempts.features.length&&J.addFeatures(Y.readFeatures(e.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))),e.lastsuccessfulstage&&(I=e.lastsuccessfulstage,V=!0,Te("#cluepage"),""!==I.question?(z=!0,je("#validatelocation").hide()):I.activitysolved?je("#validatelocation").show():je("#validatelocation").hide()),(e.firststagegeom||o)&&(A=!0),V&&(I.clue=I.clue.replace(/color/gm,"color-disabled"),je("#lastsuccessfulstageclue").html(I.clue),je("#lastsuccessfulstagename").text(I.name),je("#lastsuccesfulstagepos").text(I.position+" / "+I.totalnumber),""!==I.question?je("#questionbutton").show():je("#questionbutton").hide(),V=!1),function(){{var e;A&&(1===(e=J.getFeatures()).length&&e[0].getGeometry()instanceof ze.geom.Point?be(we,e[0].getGeometry().getCoordinates()):be(we,null,J.getExtent()),A=!1)}}(),function(){{var o;z&&(I.question=I.question.replace(/color/gm,"color-disabled"),je("#questionform").html("<legend>"+I.question+"</legend>"),o=1,je.each(I.answers,function(e,t){var a="answer"+o;t.answertext=t.answertext.replace(/color/gm,"color-disabled"),je("#questionform").append('<div class="form-check">\n                <input class="form-check-input" type="radio" name="answers" id="'.concat(a,'" value="').concat(t.id,'">\n                <label class="form-check-label" for="').concat(a,'">\n                  ').concat(t.answertext,"\n                </label>\n            </div>")),o++}),z=!1)}}(),function(){{var t;j&&((t=je("#historylist")).html(""),j=!1,0===F.length?je("<li>"+l.noattempts+"</li>").appendTo(t):F.forEach(function(e){je("<li><span class='ui-btn-icon-left "+(e.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+e.string+"</li>").appendTo(t)}))}}()),0<e.infomsg.length&&(t="",q.forEach(function(e){t+="<p>"+e+"</p>"}),e.infomsg.forEach(function(e){q.push(e),t+="<p>"+e+"</p>"}),je("#notificationsPopup .update-list").html(t),Te("#notificationsPopup")),M||je("#roadended").hide(),!M&&D||(je("#validatelocation").hide(),je("#question_button").hide(),je("#roadended").show(),me.setGeometry(null),u=!1,clearInterval(E),je("#mapplay").css("opacity","0.8"))}).fail(function(e){je("#errorPopup .play-modal-content").text(e.message),Te("#errorPopup"),clearInterval(E)})}function ke(e){var t=je("<button>",{type:"button",class:"list-group-item list-group-item-action close-modal"}).click(function(){e.setVisible(!e.getVisible())}),a=jQuery.parseHTML(e.get("name")),o=je("<div>",{class:"layer-item "+(e.getVisible()?"":"unchecked")}).append(a,je("<i class='fa fa-check-circle'>"));t.append(o),e.on("change:visible",function(){je(o).toggleClass("unchecked")}),je("#layerslist").prepend(t)}we.addInteraction(le),xe(!1,!0),E=setInterval(function(){xe(!1,!1)},t),(pe=ne).getLayers().forEach(function(t){var e=je("<button>",{type:"button",class:"list-group-item list-group-item-action close-modal"}).click(function(){pe.getLayers().forEach(function(e){e===t?e.setVisible(!0):e.setVisible(!1)})}),a=je("<div>",{text:t.get("name"),class:"layer-item "+(t.getVisible()?"":"unchecked")}).append(je("<i class='fa fa-check-circle'>"));e.append(a),t.on("change:visible",function(){je(a).toggleClass("unchecked")}),je("#layerslist").prepend(e)}),oe.forEach(function(e){ke(e)}),p&&a&&((fe=De.addgpxlayer(we,e,c,l,a,"trackgroup")).set("name",fe.get("title")),ye=(ve=fe.getLayers().item(0)).get("title"),ve.set("name",ye),ve.setVisible(!1),ke(ve));var Pe=new ze.Geolocation({projection:se.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});Pe.on("change:position",function(){var e=Pe.getPosition();ue.setGeometry(e?new ze.geom.Point(e):null),Pe.get("center")&&(be(we,e),Pe.setProperties({center:!1})),Pe.get("validate_location")&&(xe(!0,!1),Pe.setProperties({validate_location:!1}))}),Pe.on("change:accuracyGeometry",function(){ce.setGeometry(Pe.getAccuracyGeometry())});var Se=!1;function Ee(e){var t=je("<div class='play-toast slide-in-bottom'>".concat(e,"</div>"));t.appendTo(je(".play-toast-container")),setTimeout(function(){return t.addClass("slide-out-top")},3e3),setTimeout(function(){return t.remove()},3500)}function Te(e){Ge();var t=je(e);t.trigger("modal:open"),t.addClass("active"),je("".concat(e," .modal-mask")).addClass("active dismissible")}function Ge(){var e=je(".play-modal.active");e.trigger("modal:close"),e.removeClass("active"),je(".modal-mask").removeClass("active dismissible")}function Ce(e,t){return'<div class="card">\n          <div class="card-body">\n            <h5 class="card-title">'.concat(e,'</h5>\n            <h6 class="card-subtitle text-muted">').concat(t,"</h6>\n          </div>\n      </div>")}function _e(e){je(e).addClass("active"),je(".sidebar-mask").addClass("active dismissible")}function Ie(e){e?je(".global-loader").addClass("active"):je(".global-loader").removeClass("active")}function qe(e){Ge(),Ee("QR code readed: "+e),xe(!1,!1,null,e)}function Fe(e){"string"==typeof e?je("#errorQR").text(e):(null!==e.cameras[e.camera].name&&je("#errorQR").text(e.cameras[e.camera].name),1<e.cameras.length?je("#nextcamera").show():je("#nextcamera").hide())}Pe.on("error",function(e){Pe.setProperties({user_denied:!0}),Ee(e.message),e.code==e.PERMISSION_DENIED&&p&&!u&&0==Se&&setTimeout(function(){je("#popupgeoloc").popup("open",{positionTo:"window"}),Se=!0},500)}),Pe.setTracking(p),S||we.on("pointermove",function(e){var t,a;e.dragging||(t=we.getEventPixel(e.originalEvent),a=!1,we.forEachFeatureAtPixel(t,function(e){e.getGeometry()instanceof ze.geom.MultiPolygon||(a=!0)},{layerFilter:function(e){return e===$}}),we.getTargetElement().style.cursor=a?"pointer":"crosshair")}),le.on("select",function(e){var t,a,o,n,i;1===e.selected.length&&(t=e.selected[0].get("name"),a=e.selected[0].get("clue"),i=n="",(o=e.selected[0].get("info"))&&(n="<p>"+o+"</p>"),e.selected[0].get("geometrysolved")?t&&a?(i=l.stageovercome,n+=Ce(l.stagename,t),n+=Ce(l.stageclue,a)):i=l.discoveredlocation:i=l.failedlocation,je("#infoStagePopup .title").text(i),je("#infoStagePopup .play-modal-content").html(n),Te("#infoStagePopup"))}),we.on("click",function(e){var t,a=!1;we.forEachFeatureAtPixel(we.getEventPixel(e.originalEvent),function(e){return 0!==e.get("stageposition")&&"user_position"!==e.get("name")&&"user_accuracy"!==e.get("name")&&void(a=!0)}),u&&!a&&(t=we.getEventCoordinate(e.originalEvent),me.setGeometry(t?new ze.geom.Point(t):null),null!==o&&!o.geographic||ie.setPosition(e.coordinate))}),je("#searchInput").on("input",function(e){T&&T.abort(),R&&clearTimeout(R);var n=je("#searchsResults"),t=e.target.value;n.html(""),t&&2<t.length&&(je(".search-loading").addClass("active"),R=setTimeout(function(){T=Me.search(t).done(function(e){je(".search-loading").removeClass("active"),0===e.length?n.html("<li class='list-group-item'>"+l.noresults+"</li>"):je.each(e,function(e,t){var a=je("<button>",{type:"button",class:"list-group-item list-group-item-action"}).appendTo(n).click(function(){var e=[];e[0]=parseFloat(t.boundingbox[2]),e[1]=parseFloat(t.boundingbox[0]),e[2]=parseFloat(t.boundingbox[3]),e[3]=parseFloat(t.boundingbox[1]),e=ze.proj.transformExtent(e,"EPSG:4326","EPSG:3857"),be(we,null,e),je("#searchpanel").removeClass("active"),je(".sidebar-mask").removeClass("active dismissible")}),o=je("<div>",{text:t.display_name,class:"search-option"}).append(je("<i class='fa fa-chevron-circle-right'>"));a.append(o)})}).fail(function(){}).always(function(){T=null})},400))}),je("#infoStagePopup").on("modal:close",function(){le.getFeatures().clear()}),je("#acceptupdates").on("click",function(){q=[]}),je("#qrpage").on("modal:open",function(){Le.loadQR(qe,Fe)}),je("#qrpage").on("modal:close",function(){Le.unloadQR(Fe)}),je("#nextcamera").on("click",function(){var e=Le.getDetectedCameras();null!==e&&Ee("Give access to:"+e[Le.getnextwebCam()].name),Le.setnextwebcam(Fe)}),je(window).on("resize",function(){we.updateSize()}),k&&je("#autolocate").on("click",function(){var e;Pe.get("user_denied")?je("#popupgeoloc").popup("open",{positionTo:"window"}):(e=Pe.getPosition(),be(we,e))}),je("#infopanel").on("sidebar:close",function(){le.getFeatures().clear()}),je("#sendLocation").on("click",function(){u&&!me.getGeometry()?Ee(l.nomarks):xe(!0,!1)}),je("#sendAnswer").on("click",function(e){var t=je("#questionform input[type='radio']:checked");D?0===t.length?(e.preventDefault(),Ee(l.noanswerselected)):xe(!1,!1,t.val()):(e.preventDefault(),Ee(l.timeexceeded))}),je("#validatelocation").on("click",function(e){return M?(e.preventDefault(),void Ee(l.huntcompleted)):D?""!==I.question?(e.preventDefault(),Ee(l.answerwarning),void _e("#infopanel")):I.activitysolved?void 0:(e.preventDefault(),Ee(l.activitytoendwarning),void _e("#infopanel")):(e.preventDefault(),void Ee(l.timeexceeded))}),je(document).on("click",'*[data-rel="sidebar"]',function(e){var t=e.currentTarget,a=je(t.dataset.ref);a.trigger("sidebar:open"),a.addClass("active"),null!==t.dataset.dismissible&&je(".sidebar-mask").addClass("active dismissible")}),je(document).on("click",".close-sidebar, .sidebar-mask",function(){var e=je(".sidebar.active");e.trigger("sidebar:close"),e.removeClass("active"),je(".sidebar-mask").removeClass("active dismissible")}),je(document).on("click",'*[data-rel="modal"]',function(e){Ge();var t=e.currentTarget,a=je(t.dataset.ref);a.trigger("modal:open"),a.addClass("active"),je(t.dataset.ref+" .modal-mask").addClass("active"),null!==t.dataset.dismissible&&je(t.dataset.ref+" .modal-mask").addClass("dismissible")}),je(document).on("click",".close-modal, .modal-mask.dismissible",function(){Ge()})}});
//# sourceMappingURL=play_bootstrap.min.js.map

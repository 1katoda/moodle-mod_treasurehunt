define(["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","mod_treasurehunt/ol3-layerswitcher","core/str"],function(S,e,t,r,I,n,u){console.log("Loading viewgpx.js with jquery "+S().jquery);var M=30,P=0;return{addgpxlayer:function(e,t,r,n,o,a){var i=function(e,t){var r=null;e.getLayers().forEach(function(e){e.get("title")==t&&(r=e)}),r||(r=new I.layer.Group({title:t,layers:[]}),e.addLayer(r));return r}(e,a);return G([o],t,e,i,null),i},creategpxviewer:function(o,a,i,l,e){console.log("Creating gpxviewer.");var s=["aerialmap","roadmap","basemaps","searchlocation","trackviewer"],t=s.map(function(e){return{key:e,component:"treasurehunt"}});if(M=e,"global"==i)i=users_param;u.get_strings(t).done(function(e){console.log("I18N strings loaded.");for(var t=[],r=0;r<s.length;r++)t[s[r]]=e[r];if(null!=l&&null!==l.custombackgroundurl){var n=new Image;n.addEventListener("load",function(){l.imgwidth=this.naturalWidth,l.imgheight=this.naturalHeight,c(o,a,t,i,l)}),n.src=l.custombackgroundurl}else c(o,a,t,i,l)})}};function c(e,t,r,n,o){console.log("Init gpx viewer.");var a="EPSG:3857",i=null;if(void 0!==o&&null!=o){if(null!=o.custombackgroundurl){var l=I.proj.transformExtent(o.bbox,"EPSG:4326",a);if(!o.geographic){l[2],l[0];var s=l[3]-l[1],u=(l[2]+l[0])/2,c=(l[3]+l[1])/2,g=Math.round(s/o.imgheight),m=Math.round(o.imgwidth*g),d=Math.round(o.imgheight*g);l=[u-m/2,c-d/2,u+m/2,c+d/2]}i=new I.layer.Image({title:o.layername,type:o.layertype,source:new I.source.ImageStatic({url:o.custombackgroundurl,imageExtent:l}),opacity:1})}else if(null!=o.wmsurl){var h={source:new I.source.TileWMS({url:o.wmsurl,params:o.wmsparams}),type:o.layertype,title:o.layername};if(null!=o.bbox[0]&&null!=o.bbox[1]&&null!=o.bbox[2]&&null!=o.bbox[3]){var y=I.proj.transformExtent(o.bbox,"EPSG:4326",a);h.extent=y}i=new I.layer.Tile(h)}o.geographic}var p=new I.layer.Group({title:r.basemaps,layers:[new I.layer.Tile({title:r.aerialmap,type:"base",visible:!1,source:new I.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new I.layer.Tile({title:r.roadmap,type:"base",visible:!0,source:new I.source.OSM})]});null!==i&&(o.onlybase&&p.getLayers().clear(),p.getLayers().push(i));var w=new I.layer.Group({title:r.trackviewer,layers:[]}),f=(new I.layer.Heatmap({title:"Heatmap",source:new I.source.Vector({url:"gpx.php?id="+e+"&userid=24",format:new I.format.GPX}),blur:20,radius:10}),new I.control.LayerSwitcher),v=new I.Map({layers:[p,w],renderer:"canvas",target:document.getElementById("mapgpx"),view:new I.View({center:[0,0],zoom:2,minZoom:2}),controls:I.control.defaults().extend([f])});console.log("Map created in mapgpx!"),f.showPanel();var x=new I.interaction.Select({style:function(e){return L(e,x.getLayer(e).iconurl,!0)}});v.addInteraction(x),G(n,e,v,w,f);var b=new I.Overlay({element:document.getElementById("info")});function k(e){var t=b.getElement(),r=e.coordinate;S(t).popover("destroy"),b.setPosition(r),S(t).popover({placement:"top",animation:!1,html:!0,content:function(e){var t=[],r="";if(v.forEachFeatureAtPixel(e,function(e){t.push(e)}),0<t.length){var n,o,a=[];for(n=0,o=t.length;n<o;++n)a.push(t[n].get("desc"));r=a.join(", ")||"(unknown)",v.getTarget().style.cursor="pointer"}else v.getTarget().style.cursor="";return r}(v.getEventPixel(e.originalEvent))}),S(t).popover("show")}v.addOverlay(b),v.on("pointermove",function(e){e.dragging}),v.on("click",function(e){k(e)});var E=null;S("#refreshtracks").change(function(){S(this).is(":checked")?(P=0,S("#timecircle").show(),E=setInterval(function(){S("#timecircle").text(M-P++%M)},1e3)):(S("#timecircle").hide(),clearInterval(E))})}function g(e,t,r){var n=e.getView();r?n.fit(r,{duration:700}):n.animate({zoom:19,center:t,duration:700})}function G(e,i,l,s,u){var c=null;e.forEach(function(e){var t=new I.source.Vector({url:"gpx.php?id="+i+"&userid="+e.id,format:new I.format.GPX}),r=e.pic.indexOf('<img src="')+10,n=e.pic.indexOf('"',r),o=e.pic.substring(r,n),a=new I.layer.Vector({source:t,title:e.pic+""+e.fullname,style:function(e){return L(e,o,!1)}});a.iconurl=o,setInterval(function(){S("#refreshtracks").is(":checked")&&(P=0,t.clear(),t.refresh())},1e3*M),a.on("change:visible",function(){if(this.getVisible()){var e=this.getSource().getExtent();g(l,null,e)}}),t.on("change",function(){if(!S("#refreshtracks").is(":checked")){var e=t.getExtent();null===c?c=e:(c[0]=Math.min(c[0],e[0]),c[1]=Math.min(c[1],e[1]),c[2]=Math.max(c[2],e[2]),c[3]=Math.max(c[3],e[3])),g(l,null,c)}},this),s.getLayers().push(a),u&&u.renderPanel()})}function L(e,t,r){var n=[new I.style.Style({stroke:new I.style.Stroke({color:"rgba(255,255,255,0.8)",width:6+2*r}),zIndex:1+4*r}),new I.style.Style({stroke:new I.style.Stroke({color:"#ff0000",width:1+r,lineDash:[10,8]}),fill:new I.style.Fill({color:"rgba(255,0,0,0.5)"}),zIndex:2+4*r}),new I.style.Style({image:new I.style.Circle({radius:3+2*r,stroke:new I.style.Stroke({color:"white",width:1+r}),fill:new I.style.Fill({color:"red"})}),geometry:function(e){var t=e.getGeometry().getCoordinates()[0];return new I.geom.MultiPoint(t)},zIndex:3+4*r})],o=e.getGeometry().getLastCoordinate();return n.push(new I.style.Style({geometry:new I.geom.Point(o),image:new I.style.Icon({src:t,anchor:[.75,.5],rotateWithView:!1}),zIndex:4+4*r})),n}});
//# sourceMappingURL=viewgpx.min.js.map
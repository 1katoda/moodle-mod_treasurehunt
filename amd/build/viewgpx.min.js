"use strict";define(["jquery","mod_treasurehunt/ol","mod_treasurehunt/ol3-layerswitcher","core/str"],function(P,E,e,n){console.log("Loading viewgpx.js with jquery "+P().jquery);var I=30,L=0;return{addgpxlayer:function(e,t,r,n,o,a){var l=function(e,t){var r=null;e.getLayers().forEach(function(e){e.get("title")==t&&(r=e)}),r||(r=new E.layer.Group({title:t,layers:[]}),e.addLayer(r));return r}(e,a);return M([o],t,e,l,null),l},creategpxviewer:function(o,e,a,l,t){console.log("Creating gpxviewer.");var i=["aerialmap","roadmap","basemaps","searchlocation","trackviewer","pegmanlabel"],r=i.map(function(e){return{key:e,component:"treasurehunt"}});I=t,"global"==a&&(a=users_param),n.get_strings(r).done(function(e){console.log("I18N strings loaded.");for(var t,r=[],n=0;n<i.length;n++)r[i[n]]=e[n];null!=l&&null!==l.custombackgroundurl?((t=new Image).addEventListener("load",function(){l.imgwidth=this.naturalWidth,l.imgheight=this.naturalHeight,c(o,0,r,a,l)}),t.src=l.custombackgroundurl):c(o,0,r,a,l)})},createCoordsOverlay:function(e,t,r){var n=0<arguments.length&&void 0!==e?e:"#mappage",o=1<arguments.length&&void 0!==t?t:"css/ol-popup.css",a=2<arguments.length&&void 0!==r?r:"";P("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet",href:o});var l=P('<div id="popupmarker" class="ol-popup"><a href="#" id="popup-closer" class="ol-popup-closer"></a><div id="popup-content"></div></div>');P(n).append(l);var i=P("#popupmarker"),c=(P("#popup-content"),P("#popup-closer")),s=i.get(0),u=null,p=this.createPegmanLink,g=new E.Overlay({element:s,autoPan:!0,autoPanAnimation:{duration:250}});return c.click(function(){return g.setPosition(void 0),clearTimeout(u),c.blur(),P("#popup-content").html(""),!1}),E.events.listen(g,E.Object.getChangeEventType(E.Overlay.Property.POSITION),function(e){var t,r=this.getPosition();r&&(t=p(r,g.getMap(),a),P("#popup-content").html(t),u=setTimeout(function(){P("#popup-closer").trigger("click")},2e3))},g),i.hover(function(){clearTimeout(u)}),g},createPegmanLink:function(e,t,r){var n=E.proj.toLonLat(e,t.getView().getProjection()),o=E.coordinate.toStringHDMS(n);return'<a target="street" href="http://maps.google.com/?cbll='+n[1]+","+n[0]+'&cbp=12,20.09,,0,5&layer=c"><img src="pix/my_location.png" width="16" />'+r+"<br/></a><code>"+o+"</code>"}};function c(e,t,o,r,n){console.log("Init gpx viewer.");var a,l,i,c,s,u,p,g,m,d="EPSG:3857",h=null;void 0!==n&&null!=n&&(null!=n.custombackgroundurl?(p=E.proj.transformExtent(n.bbox,"EPSG:4326",d),n.geographic||(p[2],p[0],a=p[3]-p[1],l=(p[2]+p[0])/2,i=(p[3]+p[1])/2,c=Math.round(a/n.imgheight),p=[l-(s=Math.round(n.imgwidth*c))/2,i-(u=Math.round(n.imgheight*c))/2,l+s/2,i+u/2]),h=new E.layer.Image({title:n.layername,type:n.layertype,source:new E.source.ImageStatic({url:n.custombackgroundurl,imageExtent:p}),opacity:1})):null!=n.wmsurl&&(g={source:new E.source.TileWMS({url:n.wmsurl,params:n.wmsparams}),type:n.layertype,title:n.layername},null!=n.bbox[0]&&null!=n.bbox[1]&&null!=n.bbox[2]&&null!=n.bbox[3]&&(m=E.proj.transformExtent(n.bbox,"EPSG:4326",d),g.extent=m),h=new E.layer.Tile(g)),n.geographic);var y=new E.layer.Group({title:o.basemaps,layers:[new E.layer.Tile({title:o.aerialmap,type:"base",visible:!1,source:new E.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new E.layer.Tile({title:o.roadmap,type:"base",visible:!0,source:new E.source.OSM})]});null!==h&&(n.onlybase&&y.getLayers().clear(),y.getLayers().push(h));var w=new E.layer.Group({title:o.trackviewer,layers:[]}),v=(new E.layer.Heatmap({title:"Heatmap",source:new E.source.Vector({url:"gpx.php?id="+e+"&userid=24",format:new E.format.GPX}),blur:20,radius:10}),new E.control.LayerSwitcher),f=new E.Map({layers:[y,w],renderer:"canvas",target:document.getElementById("mapgpx"),view:new E.View({center:[0,0],zoom:2,minZoom:2}),controls:E.control.defaults().extend([v])});console.log("Map created in mapgpx!"),v.showPanel();var b=new E.interaction.Select({style:function(e){return T(e,b.getLayer(e).iconurl,!0)}});f.addInteraction(b),M(r,e,f,w,v);var x=new E.Overlay({element:document.getElementById("info")});function k(e,t,r,n){var o,a,l,i,c,s=[],u="";if(t.forEachFeatureAtPixel(e,function(e){s.push(e)}),0<s.length){for(var p=[],g=0,m=s.length;g<m;++g)p.push(s[g].get("desc"));u=p.join(", ")||"(unknown)",f.getTarget().style.cursor="pointer"}else o=r,a=f,l=n,i=E.proj.toLonLat(o,a.getView().getProjection()),c=E.coordinate.toStringHDMS(i),u='<a target="street" href="http://maps.google.com/?cbll='+i[1]+","+i[0]+'&cbp=12,20.09,,0,5&layer=c"><img src="pix/my_location.png" width="16" />'+l+"<br/></a><code>"+c+"</code>",f.getTarget().style.cursor="";return u}f.addOverlay(x),f.on("pointermove",function(e){e.dragging}),f.on("click",function(e){var t,r,n;t=e,r=x.getElement(),n=t.coordinate,P(r).popover("dispose"),x.setPosition(n),P(r).popover({placement:"top",animation:!1,html:!0,content:k(f.getEventPixel(t.originalEvent),f,n,o.pegmanlabel)}),P(r).popover("show")});var S=null;P("#refreshtracks").change(function(){P(this).is(":checked")?(L=0,P("#timecircle").show(),S=setInterval(function(){P("#timecircle").text(I-L++%I)},1e3)):(P("#timecircle").hide(),clearInterval(S))})}function p(e,t,r){var n=e.getView();r?n.fit(r,{duration:700}):n.animate({zoom:19,center:t,duration:700})}function M(e,l,i,c,s){var u=null;e.forEach(function(e){var t=new E.source.Vector({url:"gpx.php?id="+l+"&userid="+e.id,format:new E.format.GPX}),r=e.pic.indexOf('<img src="')+10,n=e.pic.indexOf('"',r),o=e.pic.substring(r,n),a=new E.layer.Vector({source:t,title:e.pic+""+e.fullname,style:function(e){return T(e,o,!1)}});a.iconurl=o,setInterval(function(){P("#refreshtracks").is(":checked")&&(L=0,t.clear(),t.refresh())},1e3*I),a.on("change:visible",function(){var e,t;this.getVisible()&&(e=this.getSource().getExtent(),null!==(e=(t=e)instanceof Array&&4==t.length&&t[0]!==1/0&&t[1]!==1/0&&t[2]!==1/0&&t[3]!==1/0?t:null)&&p(i,null,e))}),t.on("change",function(){var e;P("#refreshtracks").is(":checked")||(e=t.getExtent(),null===u?u=e:(u[0]=Math.min(u[0],e[0]),u[1]=Math.min(u[1],e[1]),u[2]=Math.max(u[2],e[2]),u[3]=Math.max(u[3],e[3])),p(i,null,u))},this),c.getLayers().push(a),s&&s.renderPanel()})}function T(e,t,r){var n=[new E.style.Style({stroke:new E.style.Stroke({color:"rgba(255,255,255,0.8)",width:6+2*r}),zIndex:1+4*r}),new E.style.Style({stroke:new E.style.Stroke({color:"#ff0000",width:1+r,lineDash:[10,8]}),fill:new E.style.Fill({color:"rgba(255,0,0,0.5)"}),zIndex:2+4*r}),new E.style.Style({image:new E.style.Circle({radius:3+2*r,stroke:new E.style.Stroke({color:"white",width:1+r}),fill:new E.style.Fill({color:"red"})}),geometry:function(e){var t=e.getGeometry().getCoordinates()[0];return new E.geom.MultiPoint(t)},zIndex:3+4*r})],o=e.getGeometry().getLastCoordinate();return n.push(new E.style.Style({geometry:new E.geom.Point(o),image:new E.style.Icon({src:t,anchor:[.75,.5],rotateWithView:!1}),zIndex:4+4*r})),n}});
//# sourceMappingURL=viewgpx.min.js.map

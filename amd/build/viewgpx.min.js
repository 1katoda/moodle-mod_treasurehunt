define(["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/ol3-layerswitcher"],function(a,b,c,d,e,f,g,h){var i={viewgpx:function(b,c,d,f){function h(a,b){var c=[new e.style.Style({stroke:new e.style.Stroke({color:"white",width:8})}),new e.style.Style({stroke:new e.style.Stroke({color:"#ff0000",width:4,lineDash:[10,10]}),fill:new e.style.Fill({color:"rgba(255,0,0,0.5)"})})],d=a.getGeometry(),f=d.getLastCoordinate();return c.push(new e.style.Style({geometry:new e.geom.Point(f),image:new e.style.Icon({src:b,anchor:[.75,.5],rotateWithView:!1})})),c}function i(a,b,c){var d=700,e=a.getView();c?e.fit(c,{duration:d}):e.animate({zoom:19,center:b,duration:d})}function j(a){return a?"removeClass":"addClass"}var k=g.createGeocoder("openstreetmap");a("#controlpanel").addClass("ui-widget-header ui-corner-all"),a('<div id="searchcontainer">').appendTo(a("#controlpanel")),a('<input type="search" placeholder="'+d.searchlocation+'" class="searchaddress"/>').appendTo(a("#searchcontainer")),a('<span class="ui-icon  ui-icon-search searchicon"></span>').prependTo(a("#searchcontainer")),a('<span class="ui-icon  ui-icon-closethick closeicon invisible"></span>').appendTo(a("#searchcontainer")),window.app={};var l=window.app;l.generateResizableControl=function(a){var b=a||{},c=document.createElement("button");c.innerHTML="<>",c.id="egrip";var d=document.createElement("div");d.className="ol-control ol-unselectable egrip-container",d.appendChild(c),e.control.Control.call(this,{element:d,target:b.target})},e.inherits(l.generateResizableControl,e.control.Control);var m=new e.layer.Group({title:d.basemaps,layers:[new e.layer.Tile({title:d.aerialmap,type:"base",visible:!1,source:new e.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new e.layer.Tile({title:d.roadmap,type:"base",visible:!0,source:new e.source.OSM})]}),n=new e.layer.Group({title:d.trackviewer,layers:[]}),o=new e.control.LayerSwitcher,p=new e.Map({layers:[m,n],renderer:"canvas",target:document.getElementById("mapgpx"),view:new e.View({center:[0,0],zoom:2,minZoom:2}),controls:e.control.defaults().extend([o])});o.showPanel();var q=null;f.forEach(function(a){var c=new e.source.Vector({url:"gpx.php?id="+b+"&userid="+a.id,format:new e.format.GPX}),d=a.pic.indexOf('<img src="')+10,f=a.pic.indexOf('"',d),g=a.pic.substring(d,f),j=new e.layer.Vector({source:c,title:a.pic+""+a.fullname,style:function(a){var b=h(a,g);return b}});c.on("change",function(){var a=c.getExtent();null==q?q=a:(q[0]=Math.min(q[0],a[0]),q[1]=Math.min(q[1],a[1]),q[2]=Math.max(q[2],a[2]),q[3]=Math.max(q[3],a[3])),i(p,null,q)},this),n.getLayers().push(j),o.renderPanel()});var r=function(a){var b=[];if(p.forEachFeatureAtPixel(a,function(a){b.push(a)}),b.length>0){var c,d,e=[];for(c=0,d=b.length;c<d;++c)e.push(b[c].get("desc"));document.getElementById("info").innerHTML=e.join(", ")||"(unknown)",p.getTarget().style.cursor="pointer"}else document.getElementById("info").innerHTML="&nbsp;",p.getTarget().style.cursor=""};p.on("pointermove",function(a){if(!a.dragging){var b=p.getEventPixel(a.originalEvent);r(b)}}),p.on("click",function(a){r(a.pixel)}),a(".searchaddress").autocomplete({minLength:4,source:function(a,b){var c=a.term;k.geocode(c,function(a){if(!a[0])return void b();for(var c=[],d=0,e=a.length;d<e;d++){var f,g;f=a[d].getLatitude(),g=a[d].getLongitude();var h={value:a[d].totalName,latitude:f,longitude:g,boundingbox:a[d].boundingbox};c[d]=h}b(c)})},select:function(a,b){if(b.item.boundingbox){var c=[];c[0]=parseFloat(b.item.boundingbox[2]),c[1]=parseFloat(b.item.boundingbox[0]),c[2]=parseFloat(b.item.boundingbox[3]),c[3]=parseFloat(b.item.boundingbox[1]),c=e.proj.transformExtent(c,"EPSG:4326","EPSG:3857"),i(p,null,c)}else{var d=e.proj.fromLonLat([b.item.longitude,b.item.latitude]);i(p,d)}},autoFocus:!0}).on("click",function(){a(this).autocomplete("search",a(this).value)}),a.ui.autocomplete.prototype._resizeMenu=function(){var a=this.menu.element;a.outerWidth(this.element.outerWidth())},a(document).on("touchend",".ui-dialog-titlebar-close",function(){a(this).parent().siblings(".ui-dialog-content").dialog("close")}),a(".searchaddress").on("input",function(){a(".closeicon")[j(this.value)]("invisible")}),a(".closeicon").on("touchstart click",function(b){b.preventDefault(),a(this).addClass("invisible"),a(".searchaddress").val("").change().autocomplete("close")}),window.onbeforeunload=function(a){var b=d.savewarning,a=a||window.event;if(dirty)return a&&(a.returnValue=b),b}}};return i});
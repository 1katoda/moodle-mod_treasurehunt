define(["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/ol3-layerswitcher"],function(a,b,c,d,e,f,g){function h(a,b){var c=null,d=a.getLayers();return d.forEach(function(a,d){a.get("title")==b&&(c=a)}),c||(c=new e.layer.Group({title:b,layers:[]}),a.addLayer(c)),c}function i(a,b,c){var d=700,e=a.getView();c?e.fit(c,{duration:d}):e.animate({zoom:19,center:b,duration:d})}function j(a,b,c,d,f){var g=null;a.forEach(function(a){var h=new e.source.Vector({url:"gpx.php?id="+b+"&userid="+a.id,format:new e.format.GPX}),j=a.pic.indexOf('<img src="')+10,l=a.pic.indexOf('"',j),m=a.pic.substring(j,l),n=new e.layer.Vector({source:h,title:a.pic+""+a.fullname,style:function(a){var b=k(a,m);return b}});h.on("change",function(){var a=h.getExtent();null==g?g=a:(g[0]=Math.min(g[0],a[0]),g[1]=Math.min(g[1],a[1]),g[2]=Math.max(g[2],a[2]),g[3]=Math.max(g[3],a[3])),i(c,null,g)},this),d.getLayers().push(n),f&&f.renderPanel()})}function k(a,b){var c=[new e.style.Style({stroke:new e.style.Stroke({color:"rgba(255,255,255,0.8)",width:8})}),new e.style.Style({stroke:new e.style.Stroke({color:"#ff0000",width:2,lineDash:[10,8]}),fill:new e.style.Fill({color:"rgba(255,0,0,0.5)"})})],d=a.getGeometry(),f=d.getLastCoordinate();return c.push(new e.style.Style({geometry:new e.geom.Point(f),image:new e.style.Icon({src:b,anchor:[.75,.5],rotateWithView:!1})})),c}var l={addgpxlayer:function(a,b,c,d,e,f){var g=h(a,f);return j([e],b,a,g,null),g},creategpxviewer:function(b,c,d,f,g){function h(a){var b=[],c="";if(r.forEachFeatureAtPixel(a,function(a){b.push(a)}),b.length>0){var d,e,f=[];for(d=0,e=b.length;d<e;++d)f.push(b[d].get("desc"));c=f.join(", ")||"(unknown)",r.getTarget().style.cursor="pointer"}else r.getTarget().style.cursor="";return c}function i(b){var c=s.getElement(),d=b.coordinate;a(c).popover("destroy"),s.setPosition(d),a(c).popover({placement:"top",animation:!1,html:!0,content:h(r.getEventPixel(b.originalEvent))}),a(c).popover("show")}var k="EPSG:3857",l=null,m=!0;if("undefined"!=typeof g&&null!=g){var n=e.proj.transformExtent(g.bbox,"EPSG:4326",k);l=new e.layer.Image({title:g.layername,type:g.layertype,source:new e.source.ImageStatic({url:g.custombackgroundurl,imageExtent:n}),opacity:1}),m=g.geographic}var o=new e.layer.Group({title:d.basemaps,layers:[new e.layer.Tile({title:d.aerialmap,type:"base",visible:!1,source:new e.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new e.layer.Tile({title:d.roadmap,type:"base",visible:!0,source:new e.source.OSM})]});null!=l&&(g.onlybase&&o.getLayers().clear(),o.getLayers().push(l));var p=new e.layer.Group({title:d.trackviewer,layers:[]}),q=(new e.layer.Heatmap({title:"Heatmap",source:new e.source.Vector({url:"gpx.php?id="+b+"&userid=24",format:new e.format.GPX}),blur:20,radius:10}),new e.control.LayerSwitcher),r=new e.Map({layers:[o,p],renderer:"canvas",target:document.getElementById("mapgpx"),view:new e.View({center:[0,0],zoom:2,minZoom:2}),controls:e.control.defaults().extend([q])});q.showPanel(),j(f,b,r,p,q);var s=new e.Overlay({element:document.getElementById("info")});r.addOverlay(s),r.on("pointermove",function(a){a.dragging}),r.on("click",function(a){i(a)})}};return l});
/**
 * @module    mod_treasurehunt/viewgpx
 * @package   mod_treasurehunt
 * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>, Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @author Adrian Rodriguez <huorwhisp@gmail.com>
 * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","mod_treasurehunt/ol3-layerswitcher","core/str"],(function(e,t,r,n,o,a,i){console.log("Loading viewgpx.js with jquery "+e().jquery);var l=30,u=0;return{addgpxlayer:function(e,t,r,n,a,i){var l=function(e,t){var r=null;e.getLayers().forEach((function(e){e.get("title")==t&&(r=e)})),r||(r=new o.layer.Group({title:t,layers:[]}),e.addLayer(r));return r}(e,i);return g([a],t,e,l,null),l},creategpxviewer:function(e,t,r,n,o){console.log("Creating gpxviewer.");var a=["aerialmap","roadmap","basemaps","searchlocation","trackviewer"],u=a.map((function(e){return{key:e,component:"treasurehunt"}}));if(l=o,"global"==r)r=users_param;i.get_strings(u).done((function(o){console.log("I18N strings loaded.");for(var i=[],l=0;l<a.length;l++)i[a[l]]=o[l];if(null!=n&&null!==n.custombackgroundurl){var u=new Image;u.addEventListener("load",(function(){n.imgwidth=this.naturalWidth,n.imgheight=this.naturalHeight,s(e,t,i,r,n)})),u.src=n.custombackgroundurl}else s(e,t,i,r,n)}))}};function s(t,r,n,a,i){console.log("Init gpx viewer.");var s=null;if(void 0!==i&&null!=i){if(null!=i.custombackgroundurl){var c=o.proj.transformExtent(i.bbox,"EPSG:4326","EPSG:3857");if(!i.geographic){c[2],c[0];var d=c[3]-c[1],h=(c[2]+c[0])/2,y=(c[3]+c[1])/2,p=Math.round(d/i.imgheight),f=Math.round(i.imgwidth*p),w=Math.round(i.imgheight*p);c=[h-f/2,y-w/2,h+f/2,y+w/2]}s=new o.layer.Image({title:i.layername,type:i.layertype,source:new o.source.ImageStatic({url:i.custombackgroundurl,imageExtent:c}),opacity:1})}else if(null!=i.wmsurl){var v={source:new o.source.TileWMS({url:i.wmsurl,params:i.wmsparams}),type:i.layertype,title:i.layername};if(null!=i.bbox[0]&&null!=i.bbox[1]&&null!=i.bbox[2]&&null!=i.bbox[3]){var x=o.proj.transformExtent(i.bbox,"EPSG:4326","EPSG:3857");v.extent=x}s=new o.layer.Tile(v)}i.geographic}var b=new o.layer.Group({title:n.basemaps,layers:[new o.layer.Tile({title:n.aerialmap,type:"base",visible:!1,source:new o.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new o.layer.Tile({title:n.roadmap,type:"base",visible:!0,source:new o.source.OSM})]});null!==s&&(i.onlybase&&b.getLayers().clear(),b.getLayers().push(s));var k=new o.layer.Group({title:n.trackviewer,layers:[]}),E=(new o.layer.Heatmap({title:"Heatmap",source:new o.source.Vector({url:"gpx.php?id="+t+"&userid=24",format:new o.format.GPX}),blur:20,radius:10}),new o.control.LayerSwitcher),S=new o.Map({layers:[b,k],renderer:"canvas",target:document.getElementById("mapgpx"),view:new o.View({center:[0,0],zoom:2,minZoom:2}),controls:o.control.defaults().extend([E])});console.log("Map created in mapgpx!"),E.showPanel();var I=new o.interaction.Select({style:function(e){return m(e,I.getLayer(e).iconurl,!0)}});S.addInteraction(I),g(a,t,S,k,E);var M=new o.Overlay({element:document.getElementById("info")});function P(e){var t=[],r="";if(S.forEachFeatureAtPixel(e,(function(e){t.push(e)})),t.length>0){var n,o,a=[];for(n=0,o=t.length;n<o;++n)a.push(t[n].get("desc"));r=a.join(", ")||"(unknown)",S.getTarget().style.cursor="pointer"}else S.getTarget().style.cursor="";return r}S.addOverlay(M),S.on("pointermove",(function(e){e.dragging})),S.on("click",(function(t){!function(t){var r=M.getElement(),n=t.coordinate;e(r).popover("destroy"),M.setPosition(n),e(r).popover({placement:"top",animation:!1,html:!0,content:P(S.getEventPixel(t.originalEvent))}),e(r).popover("show")}(t)}));var G=null;e("#refreshtracks").change((function(){e(this).is(":checked")?(u=0,e("#timecircle").show(),G=setInterval((function(){e("#timecircle").text(l-u++%l)}),1e3)):(e("#timecircle").hide(),clearInterval(G))}))}function c(e,t,r){var n=e.getView();r?n.fit(r,{duration:700}):n.animate({zoom:19,center:t,duration:700})}function g(t,r,n,a,i){var s=null;t.forEach((function(t){var g=new o.source.Vector({url:"gpx.php?id="+r+"&userid="+t.id,format:new o.format.GPX}),d=t.pic.indexOf('<img src="')+10,h=t.pic.indexOf('"',d),y=t.pic.substring(d,h),p=new o.layer.Vector({source:g,title:t.pic+""+t.fullname,style:function(e){return m(e,y,!1)}});p.iconurl=y,setInterval((function(){e("#refreshtracks").is(":checked")&&(u=0,g.clear(),g.refresh())}),1e3*l),p.on("change:visible",(function(){if(this.getVisible()){var e=this.getSource().getExtent();(e=null!==function(e){if(e[0]===1/0||e[1]===1/0||e[2]===1/0||e[3]===1/0)return null;return e}(e))&&c(n,null,e)}})),g.on("change",(function(){if(!e("#refreshtracks").is(":checked")){var t=g.getExtent();null===s?s=t:(s[0]=Math.min(s[0],t[0]),s[1]=Math.min(s[1],t[1]),s[2]=Math.max(s[2],t[2]),s[3]=Math.max(s[3],t[3])),c(n,null,s)}}),this),a.getLayers().push(p),i&&i.renderPanel()}))}function m(e,t,r){var n=[new o.style.Style({stroke:new o.style.Stroke({color:"rgba(255,255,255,0.8)",width:6+2*r}),zIndex:1+4*r}),new o.style.Style({stroke:new o.style.Stroke({color:"#ff0000",width:1+r,lineDash:[10,8]}),fill:new o.style.Fill({color:"rgba(255,0,0,0.5)"}),zIndex:2+4*r}),new o.style.Style({image:new o.style.Circle({radius:3+2*r,stroke:new o.style.Stroke({color:"white",width:1+r}),fill:new o.style.Fill({color:"red"})}),geometry:function(e){var t=e.getGeometry().getCoordinates()[0];return new o.geom.MultiPoint(t)},zIndex:3+4*r})],a=e.getGeometry().getLastCoordinate();return n.push(new o.style.Style({geometry:new o.geom.Point(a),image:new o.style.Icon({src:t,anchor:[.75,.5],rotateWithView:!1}),zIndex:4+4*r})),n}}));
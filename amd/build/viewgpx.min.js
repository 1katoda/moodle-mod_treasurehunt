/**
 * @module    mod_treasurehunt/viewgpx
 * @package   mod_treasurehunt
 * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>, Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @author Adrian Rodriguez <huorwhisp@gmail.com>
 * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","mod_treasurehunt/ol","mod_treasurehunt/ol3-layerswitcher","core/str"],(function(e,t,r,n){console.log("Loading viewgpx.js with jquery "+e().jquery);var o=30,a=0;return{addgpxlayer:function(e,r,n,o,a,i){var l=function(e,r){var n=null;e.getLayers().forEach((function(e){e.get("title")==r&&(n=e)})),n||(n=new t.layer.Group({title:r,layers:[]}),e.addLayer(n));return n}(e,i);return c([a],r,e,l,null),l},creategpxviewer:function(e,t,r,a,l){console.log("Creating gpxviewer.");var c=["aerialmap","roadmap","basemaps","searchlocation","trackviewer"],s=c.map((function(e){return{key:e,component:"treasurehunt"}}));if(o=l,"global"==r)r=users_param;n.get_strings(s).done((function(n){console.log("I18N strings loaded.");for(var o=[],l=0;l<c.length;l++)o[c[l]]=n[l];if(null!=a&&null!==a.custombackgroundurl){var s=new Image;s.addEventListener("load",(function(){a.imgwidth=this.naturalWidth,a.imgheight=this.naturalHeight,i(e,t,o,r,a)})),s.src=a.custombackgroundurl}else i(e,t,o,r,a)}))},createCoordsOverlay:function(r="#mappage",n="css/ol-popup.css"){e("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet",href:n});var o=e('<div id="popupmarker" class="ol-popup"><a href="#" id="popup-closer" class="ol-popup-closer"></a><div id="popup-content"></div></div>');e(r).append(o);var a=e("#popupmarker"),i=(e("#popup-content"),e("#popup-closer")),l=a.get(0),c=null,s=new t.Overlay({element:l,autoPan:!0,autoPanAnimation:{duration:250}});return i.click((function(){return s.setPosition(void 0),clearTimeout(c),i.blur(),e("#popup-content").html(""),!1})),t.events.listen(s,t.Object.getChangeEventType(t.Overlay.Property.POSITION),(function(r){var n=this.getPosition();n&&(!function(r){var n=t.proj.toLonLat(r,s.getMap().getView().getProjection()),o=t.coordinate.toStringHDMS(n),a='<a target="street" href="http://maps.google.com/?cbll='+n[1]+","+n[0]+'&cbp=12,20.09,,0,5&layer=c"><img src="pix/my_location.png" width="16" /> <code>'+o+"</code></a>";e("#popup-content").html(a)}(n),c=setTimeout(()=>{e("#popup-closer").trigger("click")},2e3))}),s),a.hover((function(){clearTimeout(c)})),s}};function i(r,n,i,l,u){console.log("Init gpx viewer.");var p=null;if(void 0!==u&&null!=u){if(null!=u.custombackgroundurl){var g=t.proj.transformExtent(u.bbox,"EPSG:4326","EPSG:3857");if(!u.geographic){g[2],g[0];var m=g[3]-g[1],d=(g[2]+g[0])/2,h=(g[3]+g[1])/2,y=Math.round(m/u.imgheight),f=Math.round(u.imgwidth*y),w=Math.round(u.imgheight*y);g=[d-f/2,h-w/2,d+f/2,h+w/2]}p=new t.layer.Image({title:u.layername,type:u.layertype,source:new t.source.ImageStatic({url:u.custombackgroundurl,imageExtent:g}),opacity:1})}else if(null!=u.wmsurl){var v={source:new t.source.TileWMS({url:u.wmsurl,params:u.wmsparams}),type:u.layertype,title:u.layername};if(null!=u.bbox[0]&&null!=u.bbox[1]&&null!=u.bbox[2]&&null!=u.bbox[3]){var b=t.proj.transformExtent(u.bbox,"EPSG:4326","EPSG:3857");v.extent=b}p=new t.layer.Tile(v)}u.geographic}var x=new t.layer.Group({title:i.basemaps,layers:[new t.layer.Tile({title:i.aerialmap,type:"base",visible:!1,source:new t.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new t.layer.Tile({title:i.roadmap,type:"base",visible:!0,source:new t.source.OSM})]});null!==p&&(u.onlybase&&x.getLayers().clear(),x.getLayers().push(p));var k=new t.layer.Group({title:i.trackviewer,layers:[]}),S=(new t.layer.Heatmap({title:"Heatmap",source:new t.source.Vector({url:"gpx.php?id="+r+"&userid=24",format:new t.format.GPX}),blur:20,radius:10}),new t.control.LayerSwitcher),E=new t.Map({layers:[x,k],renderer:"canvas",target:document.getElementById("mapgpx"),view:new t.View({center:[0,0],zoom:2,minZoom:2}),controls:t.control.defaults().extend([S])});console.log("Map created in mapgpx!"),S.showPanel();var P=new t.interaction.Select({style:function(e){return s(e,P.getLayer(e).iconurl,!0)}});E.addInteraction(P),c(l,r,E,k,S);var I=new t.Overlay({element:document.getElementById("info")});function M(e){var t=[],r="";if(E.forEachFeatureAtPixel(e,(function(e){t.push(e)})),t.length>0){var n,o,a=[];for(n=0,o=t.length;n<o;++n)a.push(t[n].get("desc"));r=a.join(", ")||"(unknown)",E.getTarget().style.cursor="pointer"}else E.getTarget().style.cursor="";return r}E.addOverlay(I),E.on("pointermove",(function(e){e.dragging})),E.on("click",(function(t){!function(t){var r=I.getElement(),n=t.coordinate;e(r).popover("destroy"),I.setPosition(n),e(r).popover({placement:"top",animation:!1,html:!0,content:M(E.getEventPixel(t.originalEvent))}),e(r).popover("show")}(t)}));var L=null;e("#refreshtracks").change((function(){e(this).is(":checked")?(a=0,e("#timecircle").show(),L=setInterval((function(){e("#timecircle").text(o-a++%o)}),1e3)):(e("#timecircle").hide(),clearInterval(L))}))}function l(e,t,r){var n=e.getView();r?n.fit(r,{duration:700}):n.animate({zoom:19,center:t,duration:700})}function c(r,n,i,c,u){var p=null;r.forEach((function(r){var g=new t.source.Vector({url:"gpx.php?id="+n+"&userid="+r.id,format:new t.format.GPX}),m=r.pic.indexOf('<img src="')+10,d=r.pic.indexOf('"',m),h=r.pic.substring(m,d),y=new t.layer.Vector({source:g,title:r.pic+""+r.fullname,style:function(e){return s(e,h,!1)}});y.iconurl=h,setInterval((function(){e("#refreshtracks").is(":checked")&&(a=0,g.clear(),g.refresh())}),1e3*o),y.on("change:visible",(function(){if(this.getVisible()){var e=this.getSource().getExtent();null!==(e=function(e){if(!(e instanceof Array)||4!=e.length)return null;if(e[0]===1/0||e[1]===1/0||e[2]===1/0||e[3]===1/0)return null;return e}(e))&&l(i,null,e)}})),g.on("change",(function(){if(!e("#refreshtracks").is(":checked")){var t=g.getExtent();null===p?p=t:(p[0]=Math.min(p[0],t[0]),p[1]=Math.min(p[1],t[1]),p[2]=Math.max(p[2],t[2]),p[3]=Math.max(p[3],t[3])),l(i,null,p)}}),this),c.getLayers().push(y),u&&u.renderPanel()}))}function s(e,r,n){var o=[new t.style.Style({stroke:new t.style.Stroke({color:"rgba(255,255,255,0.8)",width:6+2*n}),zIndex:1+4*n}),new t.style.Style({stroke:new t.style.Stroke({color:"#ff0000",width:1+n,lineDash:[10,8]}),fill:new t.style.Fill({color:"rgba(255,0,0,0.5)"}),zIndex:2+4*n}),new t.style.Style({image:new t.style.Circle({radius:3+2*n,stroke:new t.style.Stroke({color:"white",width:1+n}),fill:new t.style.Fill({color:"red"})}),geometry:function(e){var r=e.getGeometry().getCoordinates()[0];return new t.geom.MultiPoint(r)},zIndex:3+4*n})],a=e.getGeometry().getLastCoordinate();return o.push(new t.style.Style({geometry:new t.geom.Point(a),image:new t.style.Icon({src:r,anchor:[.75,.5],rotateWithView:!1}),zIndex:4+4*n})),o}}));